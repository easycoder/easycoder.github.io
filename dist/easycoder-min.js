const EasyCoder_Core={name:"EasyCoder_Core",Add:{compile:a=>{const b=a.getLino();a.next();let c;try{c=a.getValue()}catch(f){return!1}if(a.tokenIs("to"))if(a.next(),a.isSymbol()){var d=a.getSymbol();if(a.getCommandAt(d.pc).isVHolder){if("giving"===a.peek()){d=a.getValue();a.next();var e=a.getToken();a.next();a.addCommand({domain:"core",keyword:"add",lino:b,value1:c,value2:d,target:e})}else d=a.getToken(),a.next(),a.addCommand({domain:"core",keyword:"add",lino:b,value1:c,target:d});return!0}a.warning("core 'add': Expected value holder")}else{d=
a.getValue();if(a.tokenIs("giving"))return a.next(),e=a.getToken(),a.next(),a.addCommand({domain:"core",keyword:"add",lino:b,value1:c,value2:d,target:e}),!0;a.warning("core 'add'': Expected \"giving\"")}return!1},run:a=>{const b=a[a.pc],c=b.value1,d=b.value2,e=a.getSymbolRecord(b.target);if(e.isVHolder){const f=e.value[e.index];d?(a=a.getValue(d)+a.getValue(c),e.value[e.index]={type:"constant",numeric:!0,content:a}):(!f.numeric&&isNaN(f.content)&&a.nonNumericValueError(b.lino),a=parseInt(f.content)+
parseInt(a.getValue(c)),e.value[e.index]={type:"constant",numeric:!0,content:a})}else a.variableDoesNotHoldAValueError(b.lino,e.name);return b.pc+1}},Alias:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){const c=a.getToken();a.next();if(a.tokenIs("to")&&(a.next(),a.isSymbol())){const d=a.getSymbolRecord();d.used=!0;a.next();a.addCommand({domain:"core",keyword:"alias",lino:b,alias:c,symbol:d.name});return!0}}return!1},run:a=>{const b=a[a.pc],c=a.symbols[b.alias].pc,d=a[c],e=a.getSymbolRecord(b.symbol);
a[c]={pc:d.pc,domain:e.domain,keyword:e.keyword,lino:d.lino,name:d.name,alias:b.symbol};return b.pc+1}},Append:{compile:a=>{const b=a.getLino(),c=a.getNextValue();if(a.tokenIs("to")&&a.nextIsSymbol()){const d=a.getSymbolRecord();if(d.isVHolder)return a.next(),a.addCommand({domain:"core",keyword:"append",lino:b,value:c,select:d.name}),!0}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.select);try{const d=a.getValue(b.value),e=["{","["].includes(d[0])?JSON.parse(d):d,f=c.value[c.index];let g=
f.content;g=g?JSON.parse(g):[];g.push(e);f.content=JSON.stringify(g);return b.pc+1}catch(d){return a.runtimeError(b.lino,"JSON: Unable to parse value"),!1}}},Begin:{compile:a=>{a.next();a.compileFromHere(["end"]);return!0},run:a=>a[a.pc].pc+1},Callback:{compile:a=>{a.compileVariable("core","callback");return!0},run:a=>a[a.pc].pc+1},Clear:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){var c=a.getSymbolRecord();if(c.isVHolder)return c=a.getToken(),a.next(),a.addCommand({domain:"core",keyword:"clear",
lino:b,symbol:c}),!0;a.warning(`'Variable '${c.name}' does not hold a value`)}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.symbol);c.isVHolder?(a.domain[c.domain].value.put(c,{type:"boolean",content:!1}),b.numeric=!1):a.variableDoesNotHoldAValueError(b.lino,c.name);return b.pc+1}},Close:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if("module"===c.keyword)return a.next(),a.addCommand({domain:"core",keyword:"close",lino:b,module:c.name}),!0}return!1},
run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.module);a=EasyCoder.scripts[a.program];a.run(a.onClose);return b.pc+1}},Continue:{compile:a=>{a.next();return a.continue=!0}},Debug:{compile:a=>{const b=a.getLino();if(a.nextTokenIs("program")){a.next();if(["item","pc"].includes(a.getToken())){var c=a.getNextValue();a.addCommand({domain:"core",keyword:"debug",lino:b,item:c});return!0}a.addCommand({domain:"core",keyword:"debug",lino:b,item:"program"});return!0}if(a.tokenIs("symbols"))return a.next(),a.addCommand({domain:"core",
keyword:"debug",lino:b,item:"symbols"}),!0;if(a.tokenIs("symbol"))return c=a.nextToken(),a.next(),a.addCommand({domain:"core",keyword:"debug",lino:b,item:"symbol",name:c}),!0;c=a.getToken();return["step","stop"].includes(c)?(a.next(),a.addCommand({domain:"core",keyword:"debug",lino:b,item:c}),!0):!1},run:a=>{const b=a[a.pc];var c=b.item;switch(c){case "symbols":console.log(`Symbols: ${JSON.stringify(a.symbols,null,2)}`);break;case "symbol":a=a.getSymbolRecord(b.name);c=a.exporter.script;delete a.exporter;
console.log(`Symbol: ${JSON.stringify(a,null,2)}`);a.exporter.script=c;break;case "step":a.debugStep=!0;break;case "stop":a.debugStep=!1;break;case "program":console.log(`Debug program: ${JSON.stringify(a,null,2)}`);break;default:0<=c.content&&console.log(`Debug item ${c.content}: ${JSON.stringify(a[c.content],null,2)}`)}return b.pc+1}},Decode:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"decode",lino:b,symbol:c});return!0}return!1},
run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.symbol);if(c.isVHolder){const d=a.getValue(c.value[c.index]);c.value[c.index]={type:"constant",numeric:!1,content:a.decode(d)};b.numeric=!1}else a.variableDoesNotHoldAValueError(b.lino,c.name);return b.pc+1}},Divide:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){var c=a.getSymbol();var d=a.getCommandAt(c.pc).name}let e;try{e=a.getValue()}catch(f){return!1}a.tokenIs("by")&&a.next();c=a.getValue();if(a.tokenIs("giving")){a.next();if(a.isSymbol())return d=
a.getSymbol(),d=a.getCommandAt(d.pc).name,a.next(),a.addCommand({domain:"core",keyword:"divide",lino:b,value1:e,value2:c,target:d}),!0;a.warning("core 'divide'': Expected value holder")}else return"undefined"===typeof d&&a.warning("core 'divide': No target variable given"),a.addCommand({domain:"core",keyword:"divide",lino:b,value2:c,target:d}),!0;return!1},run:a=>{const b=a[a.pc],c=b.value1,d=b.value2,e=a.getSymbolRecord(b.target);if(e.isVHolder){const f=e.value[e.index];c?(a=a.getValue(c)/a.getValue(d),
e.value[e.index]={type:"constant",numeric:!0,content:Math.trunc(a)}):(!f.numeric&&isNaN(f.content)&&a.nonNumericValueError(b,lino),a=parseInt(f.content)/parseInt(a.getValue(d)),e.value[e.index]={type:"constant",numeric:!0,content:Math.trunc(a)})}else a.variableDoesNotHoldAValueError(b.lino,e.name);return b.pc+1}},Dummy:{compile:a=>{const b=a.getLino();a.next();a.addCommand({domain:"core",keyword:"dummy",lino:b});return!0},run:a=>a[a.pc].pc+1},Encode:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){const c=
a.getToken();a.next();a.addCommand({domain:"core",keyword:"encode",lino:b,symbol:c});return!0}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.symbol);if(c.isVHolder){const d=a.getValue(c.value[c.index]);c.value[c.index]={type:"constant",numeric:!1,content:a.encode(d)};b.numeric=!1}else a.variableDoesNotHoldAValueError(b.lino,c.name);return b.pc+1}},End:{compile:a=>{a.next();return!0},run:()=>0},Every:{compile:a=>{const b=a.getLino(),c=a.getNextValue(),d=a.getToken();let e=1E3;if("minute minutes second seconds tick ticks".split(" ").includes(d)){switch(d){case "minute":case "minutes":e=
6E4;break;case "second":case "seconds":e=1E3;break;case "tick":case "ticks":e=10}a.next()}a.addCommand({domain:"core",keyword:"every",lino:b,rate:c,multiplier:e});return a.completeHandler()},run:a=>{const b=a[a.pc],c=b.pc+2,d=a.getValue(b.rate)*b.multiplier;setInterval(function(){a.run(c)},d);return b.pc+1}},Exit:{compile:a=>{a.next();a.addCommand({domain:"core",keyword:"exit"});return!0},run:a=>{let b=EasyCoder.scripts[a.parent],c=a.unblocked;a.exit();!c&&b&&(b.run(b.nextPc),b.nextPc=0);return 0}},
Filter:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if(a.nextTokenIs("with")){const d=a.nextToken();a.next();a.addCommand({domain:"core",keyword:"filter",lino:b,array:c.name,func:d});return!0}}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.array),d=c.value[c.index].content,e=a.getSymbolRecord(b.func).pc;try{const f=JSON.parse(d).filter(function(g){c.a=g;a.run(e);return c.v});c.value[c.index].content=JSON.stringify(f)}catch(f){a.runtimeError(b.lino,"Can't parse this array")}return b.pc+
1}},Fork:{compile:a=>{const b=a.getLino();a.next();a.nextTokenIs("to")&&a.next();const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"fork",lino:b,label:c});return!0},run:a=>{const b=a[a.pc];try{a.run(a.symbols[b.label].pc)}catch(c){console.log(c.message),alert(c.message)}return b.pc+1}},Go:{compile:a=>{const b=a.getLino();a.nextTokenIs("to")&&a.next();const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"go",lino:b,label:c});return!0},run:a=>{const b=a[a.pc];if(b.label){if(a.verifySymbol(b.label)){const c=
a.symbols[b.label];if(c)return c.pc}a.runtimeError(b.lino,`Unknown symbol '${b.label}'`);return 0}return b.goto}},Gosub:{compile:a=>{const b=a.getLino();a.nextTokenIs("to")&&a.next();const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"gosub",lino:b,label:c});return!0},run:a=>{const b=a[a.pc];if(a.verifySymbol(b.label))return a.programStack.push(a.pc+1),a.symbols[b.label].pc;a.runtimeError(b.lino,`Unknown symbol '${b.label}'`);return 0}},If:{compile:a=>{const b=a.getLino();a.next();
var c=a.condition.compile(a);const d=a.getPc();a.addCommand({domain:"core",keyword:"if",lino:b,condition:c});a.compileOne();if(!a.getToken())return a.getCommandAt(d).else=a.getPc(),!0;a.tokenIs("else")?(c=a.getPc(),a.addCommand({domain:"core",keyword:"goto",lino:b,goto:0}),a.getCommandAt(d).else=a.getPc(),a.next(),a.compileOne(!0),a.getCommandAt(c).goto=a.getPc()):a.getCommandAt(d).else=a.getPc();return!0},run:a=>{const b=a[a.pc];return a.condition.test(a,b.condition)?b.pc+1:b.else}},Import:{compile:a=>
{var b=a.imports;let c=EasyCoder.scripts[b.caller];const d=a.getProgram();if(b.length){for(const f of b){b=c.getSymbolRecord(f);var e=a.nextToken();const g=b.keyword;if(e===g){if(e=a.compileVariable(b.domain,g,!0),e=d[a.getSymbols()[e.name].pc],e.element=b.element,e.exporter=b.exporter?b.exporter:c.script,e.exportedName=b.name,e.extra=b.extra,e.isVHolder=b.isVHolder,b.program&&(e.program=b.program.script),e.imported=!0,!a.tokenIs("and"))break}else throw Error(`Mismatched import variable type for '${b.name}'`);
}if(a.tokenIs("and"))throw Error("Imports do not match exports");}else a.next();return!0},run:a=>a[a.pc].pc+1},Index:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol(!0)){const c=a.getToken();if(a.nextTokenIs("to")){const d=a.getNextValue();a.addCommand({domain:"core",keyword:"index",lino:b,symbol:c,value:d});return!0}}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.symbol),d=a.getValue(b.value);d>=c.elements&&a.runtimeError(b.lino,`Array index ${d} is out of range for '${c.name}'`);c.index=
d;c.imported&&(EasyCoder.symbols[c.exporter].getSymbolRecord(c.exportedName).index=d);return b.pc+1}},Module:{compile:a=>{a.compileVariable("core","module");return!0},run:a=>a[a.pc].pc+1},Multiply:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){var c=a.getSymbol();var d=a.getCommandAt(c.pc).name}let e;try{e=a.getValue()}catch(f){return!1}a.tokenIs("by")&&a.next();c=a.getValue();if(a.tokenIs("giving")){a.next();if(a.isSymbol())return d=a.getSymbol(),d=a.getCommandAt(d.pc).name,a.next(),
a.addCommand({domain:"core",keyword:"multiply",lino:b,value1:e,value2:c,target:d}),!0;a.warning("core multiply: Expected value holder")}else return"undefined"===typeof d&&a.warning("core multiply: No target variable given"),a.addCommand({domain:"core",keyword:"multiply",lino:b,value2:c,target:d}),!0;return!1},run:a=>{const b=a[a.pc],c=b.value1,d=b.value2,e=a.getSymbolRecord(b.target);if(e.isVHolder){const f=e.value[e.index];c?(a=a.getValue(c)*a.getValue(d),e.value[e.index]={type:"constant",numeric:!0,
content:a}):(!f.numeric&&isNaN(f.content)&&a.nonNumericValueError(b,lino),a=parseInt(f.content)*parseInt(a.getValue(d)),e.value[e.index]={type:"constant",numeric:!0,content:a})}else a.variableDoesNotHoldAValueError(b.lino,e.name);return b.pc+1}},Negate:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"negate",lino:b,symbol:c});return!0}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.symbol);c.isVHolder?c.value[c.index]=
{type:"constant",numeric:!0,content:-c.value[c.index].content}:a.variableDoesNotHoldAValueError(b.lino,c.name);return b.pc+1}},On:{compile:a=>{const b=a.getLino();var c=a.nextToken();switch(c){case "close":case "message":case "error":return a.next(),a.addCommand({domain:"core",keyword:"on",lino:b,action:c}),a.completeHandler()}return a.isSymbol()&&(c=a.getSymbolRecord(),"callback"===c.keyword)?(a.next(),a.addCommand({domain:"core",keyword:"on",lino:b,action:c.name}),a.completeHandler()):!1},run:a=>
{const b=a[a.pc],c=b.pc+2;switch(b.action){case "close":a.onClose=c;break;case "message":a.onMessage=c;break;case "error":a.onError=c;break;default:const d=a.getSymbolRecord(b.action);if(d)d.cb=c;else return a.runtimeError(b.lino,`Unknown action '${b.action}'`),0}return b.pc+1}},Pop:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"pop",lino:b,target:c})}return!0},run:a=>{const b=a[a.pc];var c=a.getSymbolRecord(b.target);c.isVHolder||
a.variableDoesNotHoldAValueError(b.lino,c.name);a=a.dataStack.pop();c.value[c.index]=a;c.imported&&(c=EasyCoder.scripts[c.exporter].getSymbolRecord(c.exportedName),c.value[c.index]=a);return b.pc+1}},Print:{compile:a=>{const b=a.getLino();a.next();const c=a.getValue();a.addCommand({domain:"core",keyword:"print",lino:b,value:c});return!0},run:a=>{const b=a[a.pc],c=a.getFormattedValue(b.value);console.log(`(${a.script}:${b.lino}): `+c);return b.pc+1}},Push:{compile:a=>{const b=a.getLino(),c=a.getNextValue();
a.addCommand({domain:"core",keyword:"push",lino:b,value:c});return!0},run:a=>{const b=a[a.pc],c=a.getValue(b.value);a.dataStack.push({type:b.value.type,numeric:b.value.numeric,content:c});return b.pc+1}},Put:{compile:a=>{const b=a.getLino(),c=a.getNextValue();if(a.tokenIs("into")){if(a.nextIsSymbol()){const d=a.getToken();a.next();a.addCommand({domain:"core",keyword:"put",lino:b,value:c,target:d});return!0}a.warning(`core:put: No such variable: '${a.getToken()}'`)}return!1},run:a=>{const b=a[a.pc];
var c=a.getSymbolRecord(b.target);c.isVHolder||a.variableDoesNotHoldAValueError(b.lino,c.name);a=a.evaluate(b.value);c.value[c.index]={type:a.type,numeric:a.numeric,content:a.content};c.imported&&(c=EasyCoder.scripts[c.exporter].getSymbolRecord(c.exportedName),c.value[c.index]=a);return b.pc+1}},Replace:{compile:a=>{const b=a.getLino(),c=a.getNextValue();if(a.tokenIs("with")){const d=a.getNextValue();if(a.tokenIs("in")&&a.nextIsSymbol()){const e=a.getSymbolRecord();if(e.isVHolder)return a.next(),
a.addCommand({domain:"core",keyword:"replace",lino:b,original:c,replacement:d,target:e.name}),!0;throw Error(`'${e.name}' does not hold a value`);}}return!1},run:a=>{const b=a[a.pc],c=a.getValue(b.original),d=a.getValue(b.replacement),e=a.getSymbolRecord(b.target);a=a.getValue(e.value[e.index]);let f="";try{f=a.split(c).join(d)}catch(g){}e.value[e.index]={type:"constant",numeric:!1,content:f};return b.pc+1}},Require:{compile:a=>{const b=a.getLino(),c=a.nextToken();if(["css","js"].includes(c)){const d=
a.getNextValue();a.addCommand({domain:"core",keyword:"require",lino:b,type:c,url:d});return!0}throw Error("File type must be 'css' or 'js'");},run:a=>{const b=a[a.pc];a.require(b.type,a.getValue(b.url),function(){a.run(b.pc+1)});return 0}},Return:{compile:a=>{const b=a.getLino();a.next();a.addCommand({domain:"core",keyword:"return",lino:b});return!0},run:a=>a.programStack.pop()},Run:{compile:a=>{var b=a.getLino();const c=a.getNextValue(),d=[];if(a.tokenIs("with"))for(;;)if(a.nextIsSymbol(!0)){var e=
a.getSymbolRecord();d.push(e.name);a.next();if(!a.tokenIs("and"))break}if(a.tokenIs("as")&&a.nextIsSymbol(!0)){var f=a.getSymbolRecord();a.next();if("module"!==f.keyword)throw Error(`'${f.name}' is not a module`);f=f.name}let g=!1;a.tokenIs("nowait")&&(a.next(),g=!0);e=a.getPc();a.addCommand({domain:"core",keyword:"run",lino:b,script:c,imports:d,module:f,nowait:g,then:0});a.tokenIs("then")&&(b=a.getPc(),a.addCommand({domain:"core",keyword:"goto",goto:0}),a.getCommandAt(e).then=a.getPc(),a.next(),
a.compileOne(!0),a.addCommand({domain:"core",keyword:"stop"}),a.getCommandAt(b).goto=a.getPc());return!0},run:a=>{a.nextPc=a.pc+1;a.runScript(a);return 0}},Sanitize:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"core",keyword:"sanitize",lino:b,name:c});return!0}return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.name);a=a.value[a.index];a.content=JSON.stringify(JSON.parse(a.content));return b.pc+1}},Script:{compile:a=>{const b=a.getProgram();
b.script=a.nextToken();a.script=b.script;if(EasyCoder.scripts[b.script])throw delete a.script,Error(`Script '${b.script}' is already running.`);EasyCoder.scripts[b.script]=b;a.next();return!0},run:a=>a[a.pc].pc+1},Send:{compile:a=>{const b=a.getLino();let c="";a.nextTokenIs("to")||(c=a.getValue());if(a.tokenIs("to")){if(a.nextTokenIs("parent"))var d="parent";else if(a.isSymbol){d=a.getSymbolRecord();if("module"!==d.keyword)throw Error(`'${d.name}' is not a module`);d=d.name}a.next();a.addCommand({domain:"core",
keyword:"send",lino:b,message:c,recipient:d})}return!0},run:a=>{const b=a[a.pc],c=a.getValue(b.message);"parent"===b.recipient?a.parent&&(a=EasyCoder.scripts[a.parent],a.onMessage&&(a.message=c,a.run(a.onMessage))):(a=a.getSymbolRecord(b.recipient),a.program&&(a=EasyCoder.scripts[a.program],a.message=c,a.run(a.onMessage)));return b.pc+1}},Set:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){var c=a.getSymbolRecord();if(!c.isVHolder)return!1;if(a.nextTokenIs("to")){var d=a.nextToken();if(["array",
"object"].includes(d))return a.next(),a.addCommand({domain:"core",keyword:"set",lino:b,request:"setVarTo",target:c.name,type:d}),!0;for(d=[];;){var e=a.getIndex();try{d.push(a.getValue())}catch(f){a.rewindTo(e);break}}a.addCommand({domain:"core",keyword:"set",lino:b,request:"setArray",target:c.name,value:d});return!0}a.addCommand({domain:"core",keyword:"set",lino:b,request:"setBoolean",target:c.name});return!0}switch(a.getToken()){case "ready":return a.next(),a.addCommand({domain:"core",keyword:"set",
lino:b,request:"setReady"}),!0;case "element":c=a.getNextValue();if(a.tokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),"variable"===d.keyword&&a.nextTokenIs("to")))return e=a.getNextValue(),a.addCommand({domain:"core",keyword:"set",lino:b,request:"setElement",target:d.name,index:c,value:e}),!0;break;case "property":c=a.getNextValue();if(a.tokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),"variable"===d.keyword&&a.nextTokenIs("to")))return e=a.getNextValue(),a.addCommand({domain:"core",
keyword:"set",lino:b,request:"setProperty",target:d.name,name:c,value:e}),!0;break;case "arg":if(c=a.getNextValue(),a.tokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),a.nextTokenIs("to")))return e=a.getNextValue(),a.addCommand({domain:"core",keyword:"set",lino:b,request:"setArg",target:d.name,name:c,value:e}),!0}a.tokenIs("the")&&a.next();switch(a.getToken()){case "elements":a.next();if(a.tokenIs("of")){a.next();if(!a.isSymbol())throw Error(`Unknown variable '${a.getToken()}'`);c=a.getToken();
a.next();if(a.tokenIs("to"))return a.next(),d=a.getValue(),a.addCommand({domain:"core",keyword:"set",lino:b,request:"setElements",symbol:c,value:d}),!0}break;case "encoding":if(a.nextTokenIs("to"))return c=a.getNextValue(),a.addCommand({domain:"core",keyword:"set",request:"encoding",lino:b,encoding:c}),!0;a.addWarning("Unknown encoding option");break;case "payload":if(a.nextTokenIs("of")&&a.nextIsSymbol()&&(c=a.getSymbolRecord(),"callback"===c.keyword&&a.nextTokenIs("to")))return d=a.getNextValue(),
a.addCommand({domain:"core",keyword:"set",request:"setPayload",lino:b,callback:c.name,payload:d}),!0}return!1},run:a=>{const b=a[a.pc];switch(b.request){case "setBoolean":var c=a.getSymbolRecord(b.target);c.isVHolder?(c.value[c.index]={type:"boolean",content:!0},b.numeric=!1):a.variableDoesNotHoldAValueError(b.lino,c.name);break;case "setReady":if(c=EasyCoder.scripts[a.parent])c.run(c.nextPc),c.nextPc=0,a.unblocked=!0;break;case "setArray":c=a.getSymbolRecord(b.target);c.elements=b.value.length;c.value=
b.value;break;case "encoding":a.encoding=a.getValue(b.encoding);break;case "setElements":c=a.getSymbolRecord(b.symbol);var d=c.elements;c.elements=a.getValue(b.value);if(c.elements>d)for(a=d;a<c.elements;a++)c.value.push({}),c.element.push(null);else c.value=c.value.slice(0,c.elements),c.element=c.element.slice(0,c.elements);c.index>=c.elements&&(c.index=c.elements-1);break;case "setElement":c=a.getSymbolRecord(b.target);d=a.getValue(b.index);var e=JSON.parse(a.getValue(c.value[c.index])),f=a.getValue(b.value);
a.isJsonString(f)&&(f=JSON.parse(f));e[d]=f;c.value[c.index].content=JSON.stringify(e);break;case "setProperty":d=a.getValue(b.name);e=a.getValue(b.value);a.isJsonString(e)&&(e=JSON.parse(e));c=a.getSymbolRecord(b.target);f=c.value[c.index];f.numeric||(f=f.content,""===f?f={}:a.isJsonString(f)&&(f=JSON.parse(f)),f[d]=e,f=JSON.stringify(f),c.value[c.index]={type:"constant",numeric:!1,content:f});break;case "setPayload":a.getSymbolRecord(b.callback).payload=a.getValue(b.payload);break;case "setArg":d=
a.getValue(b.name);c=a.getSymbolRecord(b.target);c[d]=a.getValue(b.value);break;case "setVarTo":c=a.getSymbolRecord(b.target),c.value[c.index]={type:"constant",numeric:!1,content:"array"===b.type?"[]":"{}"}}return b.pc+1}},Sort:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if(a.nextTokenIs("with")){const d=a.nextToken();a.next();a.addCommand({domain:"core",keyword:"sort",lino:b,array:c.name,func:d});return!0}}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.array),
d=c.value[c.index].content,e=a.getSymbolRecord(b.func).pc;try{const f=JSON.parse(d);f.sort(function(g,h){c.a=g;c.b=h;a.run(e);return c.v});c.value[c.index].content=JSON.stringify(f)}catch(f){a.runtimeError(b.lino,"Can't parse this array")}return b.pc+1}},Split:{compile:a=>{const b=a.getLino();var c=null;a.nextIsSymbol()&&(c=a.getSymbolRecord());item=a.getValue();let d="\n";a.tokenIs("on")&&(d=a.getNextValue());if(["giving","into"].includes(a.getToken()))if(a.nextIsSymbol())c=a.getSymbolRecord(),a.next();
else return!1;if(null==c)throw Error("No target variable given");if("variable"===c.keyword)return a.addCommand({domain:"core",keyword:"split",lino:b,item,on:d,target:c.name}),!0;throw Error("'{targetRecord.name}' is not a variable");},run:a=>{let b=a[a.pc],c=a.getValue(b.item);var d=a.getValue(b.on);c=c.split(d);d=c.length;targetRecord=a.getSymbolRecord(b.target);targetRecord.elements=d;for(a=0;a<d;a++)targetRecord.value[a]={type:"constant",numeric:!1,content:c[a]};targetRecord.index=0;return b.pc+
1}},Stop:{compile:a=>{const b=a.getLino();a.next();if(a.more()&&a.isSymbol()&&!a.getToken().endsWith(":")){const c=a.getSymbolRecord();return"module"===c.keyword?(a.next(),a.addCommand({domain:"core",keyword:"stop",lino:b,name:c.name}),!0):!1}a.addCommand({domain:"core",keyword:"stop",lino:b,next:0});return!0},run:a=>{const b=a[a.pc];if(b.name)a=a.getSymbolRecord(b.name),EasyCoder.scripts[a.program].exit(),a.program=null;else return 0;return b.pc+1}},Take:{compile:a=>{const b=a.getLino();a.next();
let c;try{c=a.getValue()}catch(f){return!1}if(a.tokenIs("from"))if(a.next(),a.isSymbol()){var d=a.getSymbol();if(a.getCommandAt(d.pc).isVHolder){if("giving"===a.peek()){d=a.getValue();a.next();var e=a.getToken();a.next();a.addCommand({domain:"core",keyword:"take",lino:b,value1:c,value2:d,target:e})}else d=a.getToken(),a.next(),a.addCommand({domain:"core",keyword:"take",lino:b,value1:c,target:d});return!0}a.warning("core 'take'': Expected value holder")}else{d=a.getValue();if(a.tokenIs("giving"))return a.next(),
e=a.getToken(),a.next(),a.addCommand({domain:"core",keyword:"take",lino:b,value1:c,value2:d,target:e}),!0;a.warning("core 'take'': Expected \"giving\"")}return!1},run:a=>{const b=a[a.pc],c=b.value1,d=b.value2,e=a.getSymbolRecord(b.target);if(e.isVHolder){const f=e.value[e.index];d?(a=a.getValue(d)-a.getValue(c),e.value[e.index]={type:"constant",numeric:!0,content:a}):(!f.numeric&&isNaN(f.content)&&a.nonNumericValueError(b.lino),a=parseInt(a.getValue(f))-parseInt(a.getValue(c)),e.value[e.index]={type:"constant",
numeric:!0,content:a})}else a.variableDoesNotHoldAValueError(b.lino,e.name);return b.pc+1}},Test:{compile:a=>{a.next();return!0},run:a=>{console.log("Test");return a[a.pc].pc+1}},Toggle:{compile:a=>{const b=a.getLino();a.next();if(a.isSymbol()){const c=a.getSymbolPc();a.next();a.addCommand({domain:"core",keyword:"toggle",lino:b,symbol:c});return!0}return!1},run:a=>{const b=a[a.pc],c=a[b.symbol];if(c.isVHolder){const d=a.domain[c.domain];a=d.value.get(a,c.value[c.index]).content;d.value.put(c,{type:"boolean",
content:!a})}else a.variableDoesNotHoldAValueError(b.lino,c.name);return b.pc+1}},Variable:{compile:a=>{a.compileVariable("core","variable",!0);return!0},run:a=>a[a.pc].pc+1},Wait:{compile:a=>{const b=a.getLino();a.next();const c=a.getValue(a);let d=1E3;switch(a.getToken()){case "milli":case "millis":a.next();d=1;break;case "tick":case "ticks":a.next();d=10;break;case "second":case "seconds":a.next();d=1E3;break;case "minute":case "minutes":a.next(),d=6E4}a.addCommand({domain:"core",keyword:"wait",
lino:b,value:c,multiplier:d});return!0},run:a=>{const b=a[a.pc],c=a.getValue(b.value);setTimeout(function(){a.run&&a.run(b.pc+1)},c*b.multiplier);return 0}},While:{compile:a=>{var b=a.getLino();a.next();const c=a.getCondition(),d=a.getPc();a.addCommand({domain:"core",keyword:"while",lino:b,condition:c});b=a.getPc();a.addCommand({domain:"core",keyword:"goto",goto:0});a.compileOne();a.addCommand({domain:"core",keyword:"goto",goto:d});a.getCommandAt(b).goto=a.getPc();return!0},run:a=>a.condition.test(a,
a[a.pc].condition)?a.pc+2:a.pc+1},getHandler:a=>{switch(a){case "add":return EasyCoder_Core.Add;case "alias":return EasyCoder_Core.Alias;case "append":return EasyCoder_Core.Append;case "begin":return EasyCoder_Core.Begin;case "callback":return EasyCoder_Core.Callback;case "clear":return EasyCoder_Core.Clear;case "close":return EasyCoder_Core.Close;case "continue":return EasyCoder_Core.Continue;case "debug":return EasyCoder_Core.Debug;case "decode":return EasyCoder_Core.Decode;case "divide":return EasyCoder_Core.Divide;
case "dummy":return EasyCoder_Core.Dummy;case "encode":return EasyCoder_Core.Encode;case "end":return EasyCoder_Core.End;case "every":return EasyCoder_Core.Every;case "exit":return EasyCoder_Core.Exit;case "filter":return EasyCoder_Core.Filter;case "fork":return EasyCoder_Core.Fork;case "go":case "goto":return EasyCoder_Core.Go;case "gosub":return EasyCoder_Core.Gosub;case "if":return EasyCoder_Core.If;case "import":return EasyCoder_Core.Import;case "index":return EasyCoder_Core.Index;case "module":return EasyCoder_Core.Module;
case "multiply":return EasyCoder_Core.Multiply;case "negate":return EasyCoder_Core.Negate;case "on":return EasyCoder_Core.On;case "pop":return EasyCoder_Core.Pop;case "print":return EasyCoder_Core.Print;case "push":return EasyCoder_Core.Push;case "put":return EasyCoder_Core.Put;case "replace":return EasyCoder_Core.Replace;case "require":return EasyCoder_Core.Require;case "return":return EasyCoder_Core.Return;case "run":return EasyCoder_Core.Run;case "sanitize":return EasyCoder_Core.Sanitize;case "script":return EasyCoder_Core.Script;
case "send":return EasyCoder_Core.Send;case "set":return EasyCoder_Core.Set;case "sort":return EasyCoder_Core.Sort;case "split":return EasyCoder_Core.Split;case "stop":return EasyCoder_Core.Stop;case "subtract":case "take":return EasyCoder_Core.Take;case "test":return EasyCoder-Core.Test;case "toggle":return EasyCoder_Core.Toggle;case "variable":return EasyCoder_Core.Variable;case "wait":return EasyCoder_Core.Wait;case "while":return EasyCoder_Core.While;default:return!1}},run:a=>{const b=a[a.pc],
c=EasyCoder_Core.getHandler(b.keyword);c||a.runtimeError(b.lino,`Unknown keyword '${b.keyword}' in 'core' package`);return c.run(a)},isNegate:a=>"not"===a.getToken()?(a.next(),!0):!1,value:{compile:a=>{if(a.isSymbol()){var b=a.getToken();switch(a.getSymbolRecord().keyword){case "module":return a.next(),{domain:"core",type:"module",name:b};case "variable":var c=a.nextToken();return["format","modulo"].includes(c)?(a=a.getNextValue(),{domain:"core",type:c,name:b,value:a}):{domain:"core",type:"symbol",
name:b}}return null}a.tokenIs("the")&&a.next();b=a.getToken();if("true"===b)return a.next(),{domain:"core",type:"boolean",content:!0};if("false"===b)return a.next(),{domain:"core",type:"boolean",content:!1};if("random"===b)return a.next(),{domain:"core",type:"random",range:a.getValue()};if("cos"===b)return a.next(),b=a.getValue(),a.skip("radius"),a=a.getValue(),{domain:"core",type:"cos",angle_c:b,radius_c:a};if("sin"===b)return a.next(),b=a.getValue(),a.skip("radius"),a=a.getValue(),{domain:"core",
type:"sin",angle_s:b,radius_s:a};if("tan"===b)return a.next(),b=a.getValue(),a.skip("radius"),a=a.getValue(),{domain:"core",type:"tan",angle_t:b,radius_t:a};if("now timestamp today newline backtick break empty uuid".split(" ").includes(b))return a.next(),{domain:"core",type:b};if("date"===b)return{domain:"core",type:"date",value:a.getNextValue()};if(["encode","decode","lowercase","hash","reverse"].includes(b))return a.next(),a=a.getValue(),{domain:"core",type:b,value:a};if("element"===b)return b=
a.getNextValue(),a.tokenIs("of")&&a.nextIsSymbol()&&(c=a.getSymbolRecord(),a.next(),"variable"===c.keyword)?{domain:"core",type:"element",element:b,symbol:c.name}:null;if("property"===b)return b=a.getNextValue(),a.tokenIs("of")&&a.nextIsSymbol()&&(c=a.getSymbolRecord(),a.next(),"variable"===c.keyword)?{domain:"core",type:"property",property:b,symbol:c.name}:null;if("arg"===b){const e=a.getNextValue();if(a.tokenIs("of")&&a.nextIsSymbol())return b=a.getSymbolRecord(),a.next(),{domain:"core",type:"arg",
value:e,target:b.name}}if(["character","char"].includes(b)&&(b=a.getNextValue(),a.tokenIs("of")))return a=a.getNextValue(),{domain:"core",type:"char",index:b,value:a};b=a.getToken();switch(b){case "elements":if(["of","in"].includes(a.nextToken())&&a.nextIsSymbol())return c=a.getToken(),a.next(),{domain:"core",type:b,name:c};break;case "index":if(a.nextTokenIs("of")){if(a.nextIsSymbol()){if("in"===a.peek())return b=a.getValue(),a=a.getNextValue(),{domain:"core",type:"indexOf",value1:b,value2:a};c=
a.getToken();a.next();return{domain:"core",type:b,name:c}}b=a.getValue();if(a.tokenIs("in"))return a=a.getNextValue(),{domain:"core",type:"indexOf",value1:b,value2:a}}break;case "value":if(a.nextTokenIs("of"))return a.next(),{domain:"core",type:"valueOf",value:a.getValue()};break;case "length":if(a.nextTokenIs("of"))return a.next(),{domain:"core",type:"lengthOf",value:a.getValue()};break;case "left":case "right":try{if(c=a.getNextValue(),a.tokenIs("of")){var d=a.getNextValue();return{domain:"core",
type:b,count:c,value:d}}}catch(e){}break;case "from":c=a.getNextValue();d=a.tokenIs("to")?a.getNextValue():null;if(a.tokenIs("of"))return a=a.getNextValue(),{domain:"core",type:b,from:c,to:d,value:a};break;case "position":c=!1;a.nextTokenIs("nocase")&&(c=!0,a.next());if(a.tokenIs("of")&&(b=!1,a.nextTokenIs("the")&&a.nextTokenIs("last")&&(a.next(),b=!0),d=a.getValue(),a.tokenIs("in")))return a=a.getNextValue(),{domain:"core",type:"position",needle:d,haystack:a,last:b,nocase:c};break;case "payload":if(a.nextTokenIs("of")&&
a.nextIsSymbol()&&(b=a.getSymbolRecord(),"callback"===b.keyword))return a.next(),{domain:"core",type:"payload",callback:b.name};break;case "message":case "error":case "millisecond":case "time":return a.next(),{domain:"core",type:b};case "year":case "hour":case "minute":case "second":return c=null,"of"==a.nextIs()&&(c=a.getNextValue()),{domain:"core",type:b,timestamp:c};case "day":case "month":if(a.nextTokenIs("number"))return c=null,"of"==a.nextIs()&&(c=a.getNextValue()),{domain:"core",type:`${b}number`,
timestamp:c}}return null},get:(a,b)=>{var c="";switch(b.type){case "boolean":return{type:"boolean",numeric:!1,content:b.content};case "elements":return{type:"constant",numeric:!0,content:a.getSymbolRecord(b.name).elements};case "index":return{type:"constant",numeric:!0,content:a.getSymbolRecord(b.name).index};case "random":return a=a.evaluate(b.range),{type:"constant",numeric:!0,content:Math.floor(Math.random()*a.content)};case "cos":return c=a.getValue(b.angle_c),a=a.getValue(b.radius_c),{type:"constant",
numeric:!0,content:parseInt(Math.cos(.01745329*parseFloat(c))*a,10)};case "sin":return c=a.getValue(b.angle_s),a=a.getValue(b.radius_s),{type:"constant",numeric:!0,content:parseInt(Math.sin(.01745329*parseFloat(c))*a,10)};case "tan":return c=a.getValue(b.angle_t),a=a.getValue(b.radius_t),{type:"constant",numeric:!0,content:parseInt(Math.tan(.01745329*parseFloat(c))*a,10)};case "valueOf":return a=parseInt(a.getValue(b.value)),{type:"constant",numeric:!0,content:a?a:0};case "lengthOf":return{type:"constant",
numeric:!0,content:a.getValue(b.value).length};case "left":return{type:"constant",numeric:!1,content:a.getValue(b.value).substr(0,a.getValue(b.count))};case "right":return c=a.getValue(b.value),{type:"constant",numeric:!1,content:c.substr(c.length-a.getValue(b.count))};case "from":c=a.getValue(b.from);var d=b.to?a.getValue(b.to):null;a=a.getValue(b.value);return{type:"constant",numeric:!1,content:d?a.substr(c,d):a.substr(c)};case "position":return c=a.getValue(b.needle),a=a.getValue(b.haystack),b.nocase&&
(c=c.toLowerCase(),a=a.toLowerCase()),{type:"constant",numeric:!0,content:b.last?a.lastIndexOf(c):a.indexOf(c)};case "payload":return{type:"constant",numeric:!1,content:a.getSymbolRecord(b.callback).payload};case "modulo":return c=a.getSymbolRecord(b.name),a=a.evaluate(b.value),{type:"constant",numeric:!0,content:c.value[c.index].content%a.content};case "format":c=a.getSymbolRecord(b.name);c=1E3*a.getValue(c.value[c.index]);try{switch(d=JSON.parse(a.getValue(b.value)),d.mode){case "time":return{type:"constant",
numeric:!0,content:(new Date(c)).toLocaleTimeString(d.locale,d.options)};default:const e=new Date(c);return{type:"constant",numeric:!1,content:"iso"===d.format?`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}`:e.toLocaleDateString(d.locale,d.options)}}}catch(e){return a.runtimeError(a[a.pc].lino,`Can't parse ${b.value}`),null}case "empty":return{type:"constant",numeric:!1,content:""};case "now":return a=new Date,b=(new Date(a.getFullYear(),0,1)).getTimezoneOffset(),c=(new Date(a.getFullYear(),
6,1)).getTimezoneOffset(),a=Math.max(b,c)!==a.getTimezoneOffset(),b=Math.floor(Date.now()/1E3),a&&(b+=3600),{type:"constant",numeric:!0,content:b};case "timestamp":return{type:"constant",numeric:!0,content:Math.floor(Date.now()/1E3)};case "millisecond":return{type:"constant",numeric:!0,content:Math.floor(Date.now())};case "time":return a=new Date,b=new Date,b.setHours(0,0,0,0),{type:"constant",numeric:!0,content:Math.floor((a.getTime()-b.getTime())/1E3)};case "today":return a=new Date,a.setHours(0,
0,0,0),{type:"constant",numeric:!0,content:Math.floor(a.getTime()/1E3)};case "date":return c=Date.parse(a.getValue(b.value))/1E3,isNaN(c)?(a.runtimeError(a[a.pc].lino,"Invalid date format; expecting 'yyyy-mm-dd'"),null):{type:"constant",numeric:!0,content:c};case "newline":return{type:"constant",numeric:!1,content:"\n"};case "backtick":return{type:"constant",numeric:!1,content:"`"};case "break":return{type:"constant",numeric:!1,content:"<br />"};case "uuid":return{type:"constant",numeric:!1,content:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(e){var f=16*Math.random()|0;return("x"==e?f:f&3|8).toString(16)})};case "encode":return{type:"constant",numeric:!1,content:a.encode(a.getValue(b.value))};case "decode":return{type:"constant",numeric:!1,content:a.decode(a.getValue(b.value))};case "reverse":return{type:"constant",numeric:!1,content:a.getValue(b.value).split("").reverse().join("")};case "lowercase":return{type:"constant",numeric:!1,content:a.getValue(b.value).toLowerCase()};case "hash":a=a.getValue(b.value);b=0;if(0===a.length)return b;
for(c=0;c<a.length;c++)d=a.charCodeAt(c),b=(b<<5)-b+d;return{type:"constant",numeric:!0,content:b};case "element":c=a.getValue(b.element);d=a.getSymbolRecord(b.symbol);b="";try{b=JSON.parse(a.getValue(d.value[d.index]))[c]}catch(e){return a.runtimeError(a[a.pc].lino,"Can't parse JSON"),null}return{type:"constant",numeric:!1,content:"object"===typeof b?JSON.stringify(b):b};case "property":d=a.getValue(b.property);b=a.getSymbolRecord(b.symbol);b=a.getValue(b.value[b.index]);if(d&&b)if("object"===typeof b)c=
b[d];else if(c="",b=""+b,""!=b&&["{","]"].includes(b.charAt(0)))try{c=JSON.parse(b),c=c[d]}catch(e){a.runtimeError(a[a.pc].lino,`${e.message}: ${b}`)}return{type:"constant",numeric:!Array.isArray(c)&&!isNaN(c),content:"object"===typeof c?JSON.stringify(c):c};case "module":return{type:"boolean",numeric:!1,content:a.getSymbolRecord(b.name).program};case "message":return c=a.message,{type:"constant",numeric:!1,content:c};case "error":return c=a.errorMessage,{type:"constant",numeric:!1,content:c};case "indexOf":d=
a.getValue(b.value1);b=a.getValue(b.value2);try{return c=JSON.parse(b).indexOf(d),{type:"constant",numeric:!0,content:c}}catch(e){a.runtimeError(a[a.pc].lino,`Can't parse ${b}`)}break;case "arg":return c=a.getValue(b.value),c=a.getSymbolRecord(b.target)[c],{type:"constant",numeric:!isNaN(c),content:c};case "char":return c=a.getValue(b.index),{type:"constant",numeric:!1,content:a.getValue(b.value)[c]};case "year":return c=(new Date).getFullYear(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getFullYear()),
{type:"constant",numeric:!0,content:c};case "hour":return c=(new Date).getHours(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getHours()),{type:"constant",numeric:!0,content:c};case "minute":return c=(new Date).getMinutes(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getMinutes()),{type:"constant",numeric:!0,content:c};case "second":return c=(new Date).getSeconds(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getSeconds()),{type:"constant",numeric:!0,content:c};
case "monthnumber":return c=(new Date).getMonth(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getMonth()),{type:"constant",numeric:!0,content:c};case "daynumber":return c=(new Date).getDate(),b.timestamp&&(c=(new Date(1E3*a.getValue(b.timestamp))).getDate()),{type:"constant",numeric:!0,content:c};default:return null}},put:(a,b)=>{a.value[a.index]=b}},condition:{compile:a=>{if(a.isSymbol()){const c=a.getSymbolRecord();if("module"===c.keyword){if(a.nextTokenIs("is")){var b=!0;a.nextTokenIs("not")&&
(a.next(),b=!1);if(a.tokenIs("running"))return a.next(),{domain:"core",type:"moduleRunning",name:c.name,sense:b}}return null}}if(a.tokenIs("not"))return{domain:"core",type:"not",value:a.getNextValue()};try{b=a.getValue();const c=a.getToken();if("includes"===c){const d=a.getNextValue();return{domain:"core",type:"includes",value1:b,value2:d}}if("is"===c){a.next();const d=EasyCoder_Core.isNegate(a);switch(a.getToken()){case "numeric":return a.next(),{domain:"core",type:"numeric",value1:b,negate:d};case "even":return a.next(),
{domain:"core",type:"even",value1:b};case "odd":return a.next(),{domain:"core",type:"odd",value1:b};case "greater":if(a.nextTokenIs("than")){a.next();const f=a.getValue();return{domain:"core",type:"greater",value1:b,value2:f,negate:d}}break;case "less":if(a.nextTokenIs("than")){a.next();const f=a.getValue();return{domain:"core",type:"less",value1:b,value2:f,negate:d}}break;case "an":switch(a.nextToken()){case "array":return a.next(),{domain:"core",type:"array",value1:b};case "object":return a.next(),
{domain:"core",type:"object",value1:b}}break;default:const e=a.getValue();return{domain:"core",type:"is",value1:b,value2:e,negate:d}}}else if(b)return{domain:"core",type:"boolean",value:b}}catch(c){return a.warning("Can't get a value"),0}return null},test:(a,b)=>{switch(b.type){case "boolean":return a.getValue(b.value);case "numeric":var c=a.getValue(b.value1);c=" "===c||isNaN(c);return b.negate?c:!c;case "even":return 0===a.getValue(b.value1)%2;case "odd":return 1===a.getValue(b.value1)%2;case "is":return c=
a.compare(a,b.value1,b.value2),b.negate?0!==c:0===c;case "greater":return c=a.compare(a,b.value1,b.value2),b.negate?0>=c:0<c;case "less":return c=a.compare(a,b.value1,b.value2),b.negate?0<=c:0>c;case "array":return c="["===a.getValue(b.value1)[0],b.negate?!c:c;case "object":return c="{"===a.getValue(b.value1)[0],b.negate?!c:c;case "not":return!a.getValue(b.value);case "moduleRunning":return c=a.getSymbolRecord(b.name),"undefined"!==typeof c.program?(c=EasyCoder.scripts[c.program])?b.sense?c.running:
!c.running:!b.sense:!b.sense;case "includes":return c=a.getValue(b.value1),b=a.getValue(b.value2),c.includes(b)}return!1}}},EasyCoder_Browser={name:"EasyCoder_Browser",A:{compile:a=>{a.compileVariable("browser","a",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Alert:{compile:a=>{const b=a.getLino(),c=a.getNextValue();a.addCommand({domain:"browser",keyword:"alert",lino:b,value:c});return!0},run:a=>{const b=a[a.pc];a=a.getFormattedValue(b.value);alert(a);return b.pc+1}},Attach:{compile:a=>{const b=a.getLino();
a.next();if(a.isSymbol()){const c=a.getSymbolRecord();let d=c.keyword;switch(d){case "a":case "blockquote":case "button":case "canvas":case "div":case "fieldset":case "file":case "form":case "h1":case "h2":case "h3":case "h4":case "h5":case "h6":case "image":case "img":case "input":case "label":case "legend":case "li":case "option":case "p":case "pre":case "select":case "span":case "table":case "td":case "text":case "textarea":case "tr":case "ul":a.next();if(a.tokenIs("to")){let e;if(a.nextTokenIs("body"))if("div"===
d)e="body",a.next();else throw Error("Body variable must be a div");else e=a.getValue();let f=0;a.tokenIs("or")&&(a.next(),f=a.getPc()+1,a.completeHandler());a.addCommand({domain:"browser",keyword:"attach",lino:b,type:d,symbol:c.name,cssId:e,onError:f});return!0}break;default:return a.addWarning(`type '${c.keyword}' not recognized in browser 'attach'`),!1}}a.addWarning("Unrecognised syntax in 'attach'");return!1},run:a=>{const b=a[a.pc];let c=null;if("body"===b.cssId){const d=a.getSymbolRecord(b.symbol);
d.element[d.index]=document.body;d.value[d.index]={type:"constant",numeric:!1,content:c}}else return c=a.value.evaluate(a,b.cssId).content,EasyCoder_Browser.Attach.getElementById(a,b,c,100),0;"popup"===b.type&&(a.popups.push(null.id),window.onclick=function(d){a.popups.includes(d.target.id)&&(d.target.style.display="none")});return b.pc+1},getElementById:(a,b,c,d)=>{const e=document.getElementById(c);if(e){if(a.run){const f=a.getSymbolRecord(b.symbol);f.element[f.index]=e;f.value[f.index]={type:"constant",
numeric:!1,id:c};a.run(b.pc+1)}}else 0<d?setTimeout(function(){EasyCoder_Browser.Attach.getElementById(a,b,c,--d)},10):e||(b.onError?a.run(b.onError):a.runtimeError(b.lino,`No such element: '${c}'`))}},Audioclip:{compile:a=>{a.compileVariable("browser","audioclip");return!0},run:a=>a[a.pc].pc+1},BLOCKQUOTE:{compile:a=>{a.compileVariable("browser","blockquote",!1,"dom");return!0},run:a=>a[a.pc].pc+1},BUTTON:{compile:a=>{a.compileVariable("browser","button",!1,"dom");return!0},run:a=>a[a.pc].pc+1},
CANVAS:{compile:a=>{a.compileVariable("browser","canvas",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Click:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if("select"===c.keyword)return a.next(),a.addCommand({domain:"browser",keyword:"click",lino:b,target:c.name}),!0}return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.target);a.element[a.index].dispatchEvent(new Event("click"));return b.pc+1}},Clear:{compile:a=>{const b=a.getLino();var c=a.nextToken();return["body",
"styles"].includes(c)?(a.next(),a.addCommand({domain:"browser",keyword:"clear",lino:b,name:c}),!0):a.isSymbol()&&(c=a.getSymbolRecord(),"dom"===c.extra)?(a.next(),a.addCommand({domain:"browser",keyword:"clear",lino:b,name:c.name}),!0):!1},run:a=>{const b=a[a.pc];switch(b.name){case "body":document.body.innerHTML="";break;case "styles":document.querySelectorAll('link[rel="stylesheet"]').forEach(d=>d.parentNode.removeChild(d));document.querySelectorAll("style").forEach(d=>d.parentNode.removeChild(d));
break;default:a=a.getSymbolRecord(b.name);const c=a.element[a.index];switch(a.keyword){case "input":case "textarea":c.value="";break;default:c.innerHTML=""}}return b.pc+1}},Convert:{compile:a=>{const b=a.getLino();if(a.nextTokenIs("whitespace")&&a.nextTokenIs("in")&&a.nextIsSymbol()){const c=a.getSymbolRecord();if(c.isVHolder&&a.nextTokenIs("to")){const d=a.nextToken();a.next();a.addCommand({domain:"browser",keyword:"convert",lino:b,name:c.name,mode:d});return!0}}return!1},run:a=>{const b=a[a.pc];
a=a.getSymbolRecord(b.name);let c=a.value[a.index].content;switch(b.mode){case "print":c=c.split("%0a").join("\n").split("%0A").join("\n").split("%0d").join("").split("$0D").join("");break;case "html":c=c.split("%0a").join("<br />").split("%0A").join("<br />").split("%0d").join("").split("$0D").join("")}a.value[a.index].content=c;return b.pc+1}},Copy:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if("input"===c.keyword)return a.next(),a.addCommand({domain:"browser",
keyword:"copy",lino:b,name:c.name}),!0}return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.name);a=a.element[a.index];a.select();a.setSelectionRange(0,99999);document.execCommand("copy");return b.pc+1}},Create:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const d=a.getSymbolRecord();var c=d.keyword;if("audioclip"===c)return a.nextTokenIs("from")?(c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"create",type:"audioclip",name:d.name,lino:b,value:c}),!0):!1;if("a blockquote button canvas div fieldset file form h1 h2 h3 h4 h5 h6 hr image img input label legend li option p pre progress select span table tr td th text textarea ul".split(" ").includes(c))if(a.nextTokenIs("in")){if(a.nextTokenIs("body"))return a.next(),
a.addCommand({domain:"browser",keyword:"create",lino:b,name:d.name,parent:"body"}),!0;if(a.isSymbol())return c=a.getSymbolRecord(),a.next(),a.addCommand({domain:"browser",keyword:"create",lino:b,name:d.name,parent:c.name}),!0}else{if((c=a.imports)&&0<c.length&&"Codex"===a.parent)return a.addCommand({domain:"browser",keyword:"create",lino:b,name:d.name,parent:c[0],imported:!0}),!0;a.addCommand({domain:"browser",keyword:"create",lino:b,name:d.name,parent:"body"});return!0}}return!1},run:a=>{const b=
a[a.pc],c=a.getSymbolRecord(b.name);switch(b.type){case "audioclip":c.value[c.index]=b.value;break;default:if("body"===b.parent)a=document.body;else{const d=(b.imported?EasyCoder.scripts[a.parent]:a).getSymbolRecord(b.parent);d.element[d.index]||a.runtimeError(b.pc,`Element ${d.name} does not exist.`);a=d.element[d.index]}c.element[c.index]=document.createElement(c.keyword);c.element[c.index].id=`ec-${c.name}-${c.index}-${EasyCoder.elementId++}`;"a"===c.keyword&&c.element[c.index].setAttribute("href",
"#");a.appendChild(c.element[c.index])}return b.pc+1}},Disable:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"browser",keyword:"disable",lino:b,symbol:c});return!0}a.addWarning("Unrecognised syntax in 'disable'");return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.symbol);document.getElementById(a.value[a.index].content).disabled="true";return b.pc+1}},DIV:{compile:a=>{a.compileVariable("browser","div",!1,"dom");return!0},run:a=>a[a.pc].pc+
1},Enable:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"browser",keyword:"enable",lino:b,symbol:c});return!0}a.addWarning("Unrecognised syntax in 'enable'");return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.symbol);document.getElementById(a.value[a.index].content).disabled=!1;return b.pc+1}},FIELDSET:{compile:a=>{a.compileVariable("browser","fieldset",!1,"dom");return!0},run:a=>a[a.pc].pc+1},FILE:{compile:a=>{a.compileVariable("browser",
"file",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Focus:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();a.next();a.addCommand({domain:"browser",keyword:"focus",lino:b,symbol:c});return!0}a.addWarning("Unrecognised syntax in 'focus'");return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.symbol);a.element[a.index].focus();return b.pc+1}},FORM:{compile:a=>{a.compileVariable("browser","form",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Get:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const d=
a.getToken();var c=a.getSymbolRecord();if(a.nextTokenIs("from")){if(a.nextTokenIs("storage"))return a.nextTokenIs("as")?(c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"get",action:"getStorage",lino:b,target:d,key:c})):a.addCommand({domain:"browser",keyword:"get",action:"listStorage",lino:b,target:d}),!0;if(a.isSymbol()){const e=a.getSymbolRecord();if("select"===e.keyword){if("option"===c.keyword)return a.next(),a.addCommand({domain:"browser",keyword:"get",action:"getOption",lino:b,target:d,
select:e.name}),!0;throw Error("Invalid variable type");}if("form"!==e.keyword)throw Error("Invalid variable type");a.next();a.addCommand({domain:"browser",keyword:"get",action:"getForm",lino:b,target:d,form:e.name});return!0}}}a.addWarning("Unrecognised syntax in 'get'");return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.target);switch(b.action){case "getForm":a=a.getSymbolRecord(b.form);a=document.getElementById(a.value[a.index].content);a=new FormData(a);const e={};for(var d of a)e[d[0]]=
d[1].replace(/\r/g,"").replace(/\n/g,"%0a");c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(e)};break;case "listStorage":d=[];for(let f=0,g=window.localStorage.length;f<g;f++)d.push(localStorage.key(f));c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(d)};break;case "getStorage":d=window.localStorage.getItem(a.getValue(b.key));"undefined"===typeof d&&(d=null);c.value[c.index]={type:"constant",numeric:!1,content:d};break;case "getOption":d=a.getSymbolRecord(b.select),
d=d.element[d.index],c.element[c.index]=d.options[d.selectedIndex]}return b.pc+1}},H1:{compile:a=>{a.compileVariable("browser","h1",!1,"dom");return!0},run:a=>a[a.pc].pc+1},H2:{compile:a=>{a.compileVariable("browser","h2",!1,"dom");return!0},run:a=>a[a.pc].pc+1},H3:{compile:a=>{a.compileVariable("browser","h3",!1,"dom");return!0},run:a=>a[a.pc].pc+1},H4:{compile:a=>{a.compileVariable("browser","h4",!1,"dom");return!0},run:a=>a[a.pc].pc+1},H5:{compile:a=>{a.compileVariable("browser","h5",!1,"dom");
return!0},run:a=>a[a.pc].pc+1},H6:{compile:a=>{a.compileVariable("browser","h6",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Highlight:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if("dom"===c.extra)return a.next(),a.addCommand({domain:"browser",keyword:"highlight",lino:b,name:c.name}),!0}return!1},run:a=>{const b=a[a.pc];a=a.getSymbolRecord(b.name);a.element[a.index].select();return b.pc+1}},History:{compile:a=>{const b=a.getLino(),c=a.nextToken();switch(c){case "push":case "set":case "replace":a.next();
let d="",e="",f="";for(;;){const g=a.getToken();if("url"===g)d=a.getNextValue();else if("state"===g)e=a.getNextValue();else if("title"===g)f=a.getNextValue();else break}a.addCommand({domain:"browser",keyword:"history",lino:b,type:c,url:d,state:e,title:f});return!0;case "pop":case "back":case "forward":return a.next(),a.addCommand({domain:"browser",keyword:"history",lino:b,type:c}),!0}return!1},run:a=>{a.script||(a.script=`script${Date.now()/1E3}`);const b=a[a.pc];let c=a.getValue(b.state);""==c&&
(c=`{"script":"${a.script}"}`);let d=a.getValue(b.title);const e=a.getValue(b.url);switch(b.type){case "push":if(!window.history.state)return a.runtimeError(b.lino,"No state history; you need to call 'history set' on the parent"),0;window.history.pushState(c,"",e);break;case "set":case "replace":window.history.replaceState(c,d,e);break;case "pop":case "back":window.history.back();break;case "forward":window.history.forward()}return b.pc+1}},HR:{compile:a=>{a.compileVariable("browser","hr",!1,"dom");
return!0},run:a=>a[a.pc].pc+1},IMAGE:{compile:a=>{a.compileVariable("browser","image",!1,"dom");return!0},run:a=>a[a.pc].pc+1},IMG:{compile:a=>{a.compileVariable("browser","img",!1,"dom");return!0},run:a=>a[a.pc].pc+1},INPUT:{compile:a=>{a.compileVariable("browser","input",!1,"dom");return!0},run:a=>a[a.pc].pc+1},LABEL:{compile:a=>{a.compileVariable("browser","label",!1,"dom");return!0},run:a=>a[a.pc].pc+1},LEGEND:{compile:a=>{a.compileVariable("browser","legend",!1,"dom");return!0},run:a=>a[a.pc].pc+
1},LI:{compile:a=>{a.compileVariable("browser","li",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Location:{compile:a=>{const b=a.getLino();let c=!1;a.nextTokenIs("new")&&(c=!0,a.next());const d=a.getValue();a.addCommand({domain:"browser",keyword:"location",lino:b,location:d,newWindow:c});return!0},run:a=>{const b=a[a.pc];a=a.getValue(b.location);b.newWindow?window.open(a,"_blank"):window.location=a;return b.pc+1}},Mail:{compile:a=>{const b=a.getLino();if(a.nextTokenIs("to")){const c=a.getNextValue();
let d="",e="";a.tokenIs("subject")&&(d=a.getNextValue(),a.tokenIs("body")||a.tokenIs("message"))&&(a.next(),e=a.getValue());a.addCommand({domain:"browser",keyword:"mail",lino:b,to:c,subject:d,body:e});return!0}return!1},run:a=>{const b=a[a.pc];window.location.href=b.subject?`mailto:${a.getValue(b.to)}`+`?subject=${a.getValue(b.subject)}&body=${encodeURIComponent(a.getValue(b.body))}`:`mailto:${a.getValue(b.to)}`;return b.pc+1}},On:{compile:a=>{const b=a.getLino();var c=a.nextToken();switch(c){case "change":a.next();
if(a.isSymbol()){var d=a.getSymbolRecord();a.next();if("dom"!==d.extra)return!1;a.addCommand({domain:"browser",keyword:"on",lino:b,action:c,symbol:d.name});return a.completeHandler()}break;case "click":if(a.nextTokenIs("document"))return a.next(),a.addCommand({domain:"browser",keyword:"on",lino:b,action:"clickDocument"}),a.completeHandler();if(a.isSymbol()){d=a.getSymbolRecord();a.next();if("dom"!==d.extra)return!1;a.addCommand({domain:"browser",keyword:"on",lino:b,action:c,symbol:d.name});return a.completeHandler()}break;
case "key":case "leave":return a.next(),a.addCommand({domain:"browser",keyword:"on",lino:b,action:c}),a.completeHandler();case "window":return a.nextTokenIs("resize")?(a.next(),a.addCommand({domain:"browser",keyword:"on",lino:b,action:"windowResize"}),a.completeHandler()):!1;case "browser":case "restore":if("browser"===c&&!a.nextTokenIs("back"))return!1;a.next();a.addCommand({domain:"browser",keyword:"on",lino:b,action:"browserBack"});return a.completeHandler();case "swipe":return["left","right"].includes(a.nextToken())?
(c=a.getToken(),a.next(),a.addCommand({domain:"browser",keyword:"on",lino:b,action:"swipe",direction:c}),a.completeHandler()):!1;case "pick":if(a.nextIsSymbol()){d=a.getSymbolRecord();a.next();if("dom"!==d.extra)return!1;a.addCommand({domain:"browser",keyword:"on",lino:b,action:c,symbol:d.name});return a.completeHandler()}return!1;case "drag":case "drop":return a.next(),a.addCommand({domain:"browser",keyword:"on",lino:b,action:c}),a.completeHandler()}a.addWarning("Unrecognised syntax in 'on'");return!1},
run:a=>{let b;const c=a[a.pc];switch(c.action){case "change":b=a.getSymbolRecord(c.symbol);b.program=a.script;b.element.forEach(function(f,g){f&&(f.targetRecord=b,f.targetIndex=g,f.targetPc=c.pc+2,f.addEventListener("change",h=>{h.stopPropagation();if(0<a.length){const k=h.target;"undefined"!==typeof k.targetRecord&&(k.targetRecord.index=k.targetIndex,setTimeout(function(){EasyCoder.timestamp=Date.now();EasyCoder.scripts[k.targetRecord.program].run(k.targetPc)},1))}}))});break;case "click":b=a.getSymbolRecord(c.symbol);
b.program=a.script;b.element.forEach(function(f,g){f&&(f.targetRecord=b,f.targetIndex=g,f.targetPc=c.pc+2,f.onclick=function(h){h.stopPropagation();EasyCoder_Browser.clickData={target:f,clientX:h.clientX,clientY:h.clientY};if(0<a.length){const k=h.target;"radio"!=k.type&&k.blur();"undefined"!==typeof k.targetRecord&&(k.targetRecord.index=k.targetIndex,setTimeout(function(){EasyCoder.timestamp=Date.now();EasyCoder.scripts[k.targetRecord.program].run(k.targetPc)},1))}return!1})});break;case "clickDocument":a.targetPc=
c.pc+2;var d=f=>{EasyCoder.timestamp=Date.now();var g=f.target||f.srcElement;let h="";for(;g.parentNode;){if("A"===g.tagName){h=g.href;a.docPath=h.slice(-(h.length-window.location.href.length));break}g=g.parentNode}for(;g.parentNode;){if(0===g.id.indexOf("ec-")){g=g.id.slice(3);let k=g.indexOf("-");a.varName=g.slice(0,k);g=g.slice(k+1);k=g.indexOf("-");a.varIndex=parseInt(g.slice(0,k));break}g=g.parentNode}0===h.indexOf(window.location.href)&&(a.run(a.targetPc),f.preventDefault())};document.addEventListener?
document.addEventListener("click",d):document.attachEvent&&document.attachEvent("onclick",d);break;case "swipe":let e;switch(c.direction){case "left":a.onSwipeLeft=c.pc+2;break;case "right":a.onSwipeRight=c.pc+2}document.addEventListener("touchstart",f=>{e=(f.touches||f.originalEvent.touches)[0].clientX},!1);document.addEventListener("touchmove",f=>{f.stopImmediatePropagation();e&&(f=e-f.touches[0].clientX,150<Math.abs(f)&&(e=null,0<f&&a.onSwipeLeft?a.run(a.onSwipeLeft):0>f&&a.onSwipeRight&&a.run(a.onSwipeRight)))},
!1);break;case "pick":d=a.getSymbolRecord(c.symbol);document.pickRecord=d;d.element.forEach(function(f,g){f&&(document.pickIndex=g,f.pickIndex=g,f.mouseDownPc=c.pc+2,"ontouchstart"in f?(f.addEventListener("touchstart",function(h){const k=h.targetTouches[0].target;document.pickX=h.touches[0].clientX;document.pickY=h.touches[0].clientY;k.blur();setTimeout(function(){document.pickRecord.index=k.pickIndex;a.run(k.mouseDownPc)},1)},!1),f.addEventListener("touchmove",function(h){document.dragX=h.touches[0].clientX;
document.dragY=h.touches[0].clientY;setTimeout(function(){a.run(document.mouseMovePc)},1);return!1},!1),f.addEventListener("touchend",function(){setTimeout(function(){a.run(document.mouseUpPc)},1);return!1})):f.onmousedown=function(h){h=h?h:window.event;h.stopPropagation();if(0<a.length){const k=h.target?h.target:h.srcElement;k.offsetX=h.offsetX;k.offsetY=h.offsetY;document.pickX=h.clientX;document.pickY=h.clientY;k.blur();setTimeout(function(){document.pickRecord.index=k.pickIndex;a.run(k.mouseDownPc)},
1)}document.onmousemove=function(k){k=k?k:window.event;k.stopPropagation();document.dragX=k.clientX;document.dragY=k.clientY;document.onmousemove&&setTimeout(function(){a.run(document.mouseMovePc)},1);return!1};window.onmouseup=function(){document.onmousemove=null;document.onmouseup=null;setTimeout(function(){a&&a.run&&a.run(document.mouseUpPc)},1);return!1};return!1})});break;case "drag":document.mouseMovePc=c.pc+2;break;case "drop":document.mouseUpPc=c.pc+2;break;case "key":"undefined"===typeof document.onKeyListeners&&
(document.onKeyListeners=[]);document.onKeyListeners.includes(a)||document.onKeyListeners.push(a);a.onKeyPc=c.pc+2;document.onkeydown=function(f){for(const g of document.onKeyListeners){g.key=f.key;try{setTimeout(function(){g.run(g.onKeyPc)},1)}catch(h){console.log(`Error: ${h.message}`)}}return!0};break;case "windowResize":a.onWindowResize=c.pc+2;window.addEventListener("resize",function(){a.run(a.onWindowResize)});break;case "browserBack":a.onBrowserBack=c.pc+2;break;case "leave":window.addEventListener("beforeunload",
function(){a.run(c.pc+2)})}return c.pc+1}},OPTION:{compile:a=>{a.compileVariable("browser","option",!1,"dom");return!0},run:a=>a[a.pc].pc+1},P:{compile:a=>{a.compileVariable("browser","p",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Play:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getSymbolRecord();if("audioclip"===c.keyword)return a.next(),a.addCommand({domain:"browser",keyword:"play",lino:b,target:c.name}),!0}return!1},run:a=>{const b=a[a.pc],c=a.getSymbolRecord(b.target);a=a.value.evaluate(a,
c.value[c.index]).content;(new Audio(a)).play();return b.pc+1}},PRE:{compile:a=>{a.compileVariable("browser","pre",!1,"dom");return!0},run:a=>a[a.pc].pc+1},PROGRESS:{compile:a=>{a.compileVariable("browser","progress",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Put:{compile:a=>{const b=a.getLino(),c=a.getNextValue();if(a.tokenIs("into")&&a.nextTokenIs("storage")&&a.nextTokenIs("as")){const d=a.getNextValue();a.addCommand({domain:"browser",keyword:"put",lino:b,value:c,key:d});return!0}return!1},run:a=>
{const b=a[a.pc];window.localStorage.setItem(a.getValue(b.key),a.getValue(b.value));return b.pc+1}},Remove:{compile:a=>{const b=a.getLino();if(a.nextTokenIs("element")&&a.nextIsSymbol()){var c=a.getSymbolRecord();if("dom"!=c.extra)return a.warning(`'${c.name}' is not a DOM element`),!1;a.next();a.addCommand({domain:"browser",keyword:"remove",type:"removeElement",lino:b,element:c.name});return!0}if(a.tokenIs("attribute")&&(c=a.getNextValue(),a.tokenIs("of")&&a.nextIsSymbol())){var d=a.getSymbolRecord();
if("dom"!==d.extra)throw Error(`Inappropriate type '${d.keyword}'`);a.next();a.addCommand({domain:"browser",keyword:"remove",type:"removeAttribute",lino:b,attribute:c,target:d.name});return!0}try{if(d=a.getValue(),a.tokenIs("from")&&a.nextTokenIs("storage"))return a.next(),a.addCommand({domain:"browser",keyword:"remove",type:"removeStorage",key:d}),!0}catch(e){}return!1},run:a=>{const b=a[a.pc];switch(b.type){case "removeAttribute":var c=a.getValue(b.attribute);a=a.getSymbolRecord(b.target);target=
a.element[a.index];target.removeAttribute(c);break;case "removeElement":c=a.getSymbolRecord(b.element);(c=c.element[c.index])&&c.parentElement.removeChild(c);break;case "removeStorage":c=a.getValue(b.key),window.localStorage.removeItem(c)}return b.pc+1}},Request:{compile:a=>{const b=a.getLino();if("fullscreen"===a.nextToken()){let c="";"exit"===a.nextToken()&&(c="exit",a.next());a.addCommand({domain:"browser",keyword:"request",lino:b,option:c});return!0}return!1},run:a=>{a=a[a.pc];"exit"===a.option?
document.exitFullscreen():document.documentElement.requestFullscreen();return a.pc+1}},SELECT:{compile:a=>{a.compileVariable("browser","select",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Scroll:{compile:a=>{const b=a.getLino();let c=null;a.nextIsSymbol()&&(c=a.getSymbolRecord().name,a.next());if(a.tokenIs("to")){const d=a.getNextValue();a.addCommand({domain:"browser",keyword:"scroll",lino:b,name:c,to:d});return!0}return!1},run:a=>{const b=a[a.pc],c=a.getValue(b.to);b.name?(a=a.getSymbolRecord(b.name),
a.element[a.index].scrollTo(0,c)):window.scrollTo(0,c);return b.pc+1}},SECTION:{compile:a=>{a.compileVariable("browser","section",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Set:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){var c=a.getSymbolRecord(),d=c.name;if("dom"===c.extra&&"from"===a.nextToken()&&a.nextIsSymbol()){if("select"===c.keyword){var e=a.getSymbolRecord();return"variable"===e.keyword?(c=null,a.nextTokenIs("as")&&(c=a.getNextValue()),a.addCommand({domain:"browser",keyword:"set",
lino:b,type:"setSelect",select:d,source:e.name,display:c}),!0):!1}c=a.getToken();a.next();a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setContentVar",source:c,target:d});return!0}}else{var f=a.getToken();"the"===f&&(f=a.nextToken());if("title"===f){if(a.nextTokenIs("to"))return d=a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setTitle",value:d}),!0}else if("content"===f){if(a.nextTokenIs("of")){if(a.nextIsSymbol()){d=a.getToken();if(a.nextTokenIs("from")&&
a.nextIsSymbol())return c=a.getToken(),a.next(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setContentVar",source:c,target:d}),!0;if(a.tokenIs("to"))return c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setContent",value:c,target:d}),!0}throw Error(`'${a.getToken()}' is not a symbol`);}}else if("class"===f){if(a.nextTokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),"dom"===d.extra&&a.nextTokenIs("to")))return c=a.getNextValue(),a.addCommand({domain:"browser",
keyword:"set",lino:b,type:"setClass",symbolName:d.name,value:c}),!0}else if("id"===f){if(a.nextTokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),"dom"===d.extra&&a.nextTokenIs("to")))return c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setId",symbolName:d.name,value:c}),!0}else if("text"===f){if(a.nextTokenIs("of")&&a.nextIsSymbol())switch(d=a.getSymbolRecord(),d.keyword){case "button":case "input":case "span":case "label":case "legend":if(a.nextTokenIs("to"))return c=
a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setText",symbolName:d.name,value:c}),!0}}else if("size"===f){if(a.nextTokenIs("of")&&a.nextIsSymbol())switch(d=a.getSymbolRecord(),d.keyword){case "input":if(a.nextTokenIs("to"))return c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setSize",symbolName:d.name,value:c}),!0}}else if("attribute"===f){if(a.next(),d=a.getValue(),a.tokenIs("of")&&a.nextIsSymbol(!0))return c=a.getSymbolRecord().name,a.next(),
e={type:"boolean",content:!0},a.tokenIs("to")&&(e=a.getNextValue()),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setAttribute",symbolName:c,attributeName:d,attributeValue:e}),!0}else{if("attributes"===f){if(a.nextTokenIs("of")&&a.nextIsSymbol()){c=a.getSymbolRecord();d=c.name;if("dom"!==c.extra)return a.warning(`'${d}' is not a DOM type`),!1;if(a.nextTokenIs("to")&&(c=a.getNextValue()))return a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setAttributes",symbolName:d,attributes:c}),
!0}a.warning(`'${a.getToken()}' is not a symbol`);return!1}if("style"===f){if(a.nextTokenIs("of")){if(a.nextIsSymbol()){c=a.getSymbolRecord();d=c.name;if("dom"!==c.extra)return a.warning(`'${d}' is not a DOM type`),!1;if(a.nextTokenIs("to")&&(c=a.getNextValue()))return a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setStyles",symbolName:d,styleValue:c}),!0}a.warning(`'${a.getToken()}' is not a symbol`);return!1}d=a.getValue();c="setStyle";e="";f=a.getToken();if("of"===f){if("body"===a.nextToken())c=
"setBodyStyle";else if(a.isSymbol()){if(f=a.getSymbolRecord(),e=f.name,"dom"!==f.extra)throw Error(`'${e}' is not a DOM type`);}else throw Error(`'${a.getToken()}' is not a known symbol`);if(a.nextTokenIs("to")&&(f=a.getNextValue()))return a.addCommand({domain:"browser",keyword:"set",lino:b,type:c,symbolName:e,styleName:d,styleValue:f}),!0}else if("to"===f&&(c=a.getNextValue()))return a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setHeadStyle",styleName:d,styleValue:c}),!0}else if("default"===
f&&a.nextTokenIs("of")&&a.nextIsSymbol()&&(d=a.getSymbolRecord(),"select"===d.keyword&&a.nextTokenIs("to")))return c=a.getNextValue(),a.addCommand({domain:"browser",keyword:"set",lino:b,type:"setDefault",name:d.name,value:c}),!0}}a.addWarning("Unrecognised syntax in 'set'");return!1},run:a=>{const b=a[a.pc];let c;switch(b.type){case "setContentVar":var d=a.getSymbolRecord(b.source);var e=a.getSymbolRecord(b.target);var f=document.getElementById(d.value[d.index].content);c=e.element[e.index];c||(d=
a.getValue(e.value[e.index]),c=document.getElementById(d));c.innerHTML=f.innerHTML;break;case "setContent":d=a.getValue(b.value);e=a.getSymbolRecord(b.target);c=e.element[e.index];if(!c){f=e.value[e.index].content;if(!f)return a.runtimeError(b.lino,`Variable '${e.name}' has not been attached to a DOM element.`),0;c=document.getElementById(f)}e.element[e.index]=c;switch(e.keyword){case "text":case "textarea":case "input":c.value=d;break;default:c.innerHTML=d}break;case "setSelect":sourceRecord=a.getSymbolRecord(b.source);
e=a.getValue(sourceRecord.value[sourceRecord.index]);d="";try{d=JSON.parse(e)}catch(l){return a.runtimeError(b.lino,"Can't parse JSON"),0}e=a.getSymbolRecord(b.select);const h=e.element[e.index];h.options.length=0;const k=a.getValue(b.display);d.forEach(function(l){const p=k?a.decode(l[k]):null,q=document.createElement("option");q.innerHTML=p?p:l;l=p?JSON.stringify(l):l;q.value=l;h.appendChild(q)});h.selectedIndex=k?d.indexOf(k):-1;break;case "setClass":e=a.getSymbolRecord(b.symbolName);c=e.element[e.index];
c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d));a.getValue(b.value).split(" ").forEach(function(l){c.classList.remove(l);c.classList.add(l)});break;case "setId":e=a.getSymbolRecord(b.symbolName);c=e.element[e.index];c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d));c.id=a.getValue(b.value);break;case "setText":e=a.getSymbolRecord(b.symbolName);c=e.element[e.index];c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d));d=a.getValue(b.value);switch(e.keyword){case "button":case "span":case "label":case "legend":c.innerHTML=
d;break;case "input":c.value=d}break;case "setSize":e=a.getSymbolRecord(b.symbolName);"input"===e.keyword?(c=e.element[e.index],c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d)),c.size=a.getValue(b.value)):a.runtimeError(b.lino,`Inappropriate variable type '${e.name}'`);break;case "setAttribute":e=a.getSymbolRecord(b.symbolName);c=e.element[e.index];c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d));d=a.getValue(b.attributeName);"boolean"===b.attributeValue.type?c.setAttribute(d,
b.attributeValue.content):c.setAttribute(d,a.getValue(b.attributeValue));break;case "setAttributes":e=a.getSymbolRecord(b.symbolName);c=e.element[e.index];c||(d=a.getValue(e.value[e.index]),c=document.getElementById(d));for(d=c.attributes.length-1;0<=d;d--)c.removeAttribute(c.attributes[d].name);d=a.getValue(b.attributes).split(" ");for(e=0;e<d.length;e++){f=d[e];var g=f.indexOf("=");0<g?c.setAttribute(f.substr(0,g),f.substr(g+1)):c.setAttribute(f,f)}break;case "setStyle":case "setStyles":e=a.getSymbolRecord(b.symbolName);
c=e.element[e.index];if(!c){d=e.value[e.index];if(!d.type)return a.runtimeError(b.lino,`Variable '${e.name}' is not attached to a DOM element.`),0;d=a.getValue(d);c=document.getElementById(d)}d=a.getValue(b.styleValue);if(!e.element[e.index])return a.runtimeError(b.lino,`Variable '${e.name}' has no DOM element.`),0;switch(b.type){case "setStyle":c.style[b.styleName.content]=d;break;case "setStyles":c.style.cssText=d}break;case "setHeadStyle":e=a.getValue(b.styleName);f=a.getValue(b.styleValue);d=
document.createElement("style");d.innerHTML=`${e} ${f}`;for(f=0;f<document.head.childNodes.length;f++)if(g=document.head.childNodes[f],"STYLE"===g.tagName&&0===g.innerHTML.indexOf(`${e} `)){document.head.removeChild(g);break}document.head.appendChild(d);break;case "setBodyStyle":d=a.getValue(b.styleValue);switch(b.styleName.content){case "background":document.body.style.background=d;break;default:return a.runtimeError(b.lino,`Unsupported body attribute '${b.styleName.content}'`),0}break;case "setTitle":document.title=
a.getValue(b.value);break;case "setDefault":for(e=a.getSymbolRecord(b.name),d=a.getValue(b.value),e=e.element[e.index],f=0;f<e.options.length;f++)if(e.options[f].value===d){e.selectedIndex=f;break}}return b.pc+1}},SPAN:{compile:a=>{a.compileVariable("browser","span",!1,"dom");return!0},run:a=>a[a.pc].pc+1},TABLE:{compile:a=>{a.compileVariable("browser","table",!1,"dom");return!0},run:a=>a[a.pc].pc+1},TR:{compile:a=>{a.compileVariable("browser","tr",!1,"dom");return!0},run:a=>a[a.pc].pc+1},TD:{compile:a=>
{a.compileVariable("browser","td",!1,"dom");return!0},run:a=>a[a.pc].pc+1},TH:{compile:a=>{a.compileVariable("browser","th",!1,"dom");return!0},run:a=>a[a.pc].pc+1},TEXTAREA:{compile:a=>{a.compileVariable("browser","textarea",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Trace:{compile:a=>{const b=a.getLino(),c=[];if(a.nextIsSymbol()){for(;a.isSymbol();)c.push(a.getToken()),a.next();let d="horizontal";if(a.tokenIs("horizontal")||a.tokenIs("vertical"))d=a.getToken(),a.next();a.addCommand({domain:"browser",
keyword:"trace",variant:"setup",lino:b,variables:c,alignment:d});return!0}a.addCommand({domain:"browser",keyword:"trace",variant:"run",lino:b});return!0},run:a=>{var b=a[a.pc];switch(b.variant){case "setup":console.log("Set up tracer");a.tracer={variables:b.variables,alignment:b.alignment};break;case "run":console.log("Run tracer");a.tracer||(a.tracer={variables:[],alignment:"horizontal"});if(!a.tracing){if(b=document.getElementById("easycoder-tracer"))b.innerHTML='<div><input id="easycoder-run-button" type="button" value="Run" /><input id="easycoder-step-button" type="button" value="Step" /><div id="easycoder-tracer-content" style="border:1px solid black;padding:4px";width:100%></div>',
b.style.display="none";a.tracing=!0}a.stop=!1}return a.pc+1}},UL:{compile:a=>{a.compileVariable("browser","ul",!1,"dom");return!0},run:a=>a[a.pc].pc+1},Upload:{compile:a=>{const b=a.getLino();if(a.nextIsSymbol()){const c=a.getToken();if(a.nextTokenIs("to")){const d=a.getNextValue();if(a.tokenIs("with")&&a.nextIsSymbol()){const e=a.getToken();if(a.nextTokenIs("and")&&a.nextIsSymbol()){const f=a.getToken();a.next();a.addCommand({domain:"browser",keyword:"upload",lino:b,file:c,path:d,progress:e,status:f});
return!0}}}}return!1},run:a=>{const b=a[a.pc];var c=a.getSymbolRecord(b.file),d=a.getValue(b.path),e=a.getSymbolRecord(b.progress);const f=a.getSymbolRecord(b.status),g=e.element[e.index],h=f.element[f.index];if(e=c.element[c.index].files[0])c=new FormData,c.append("source",e),c.append("path",d),e=new XMLHttpRequest,e.upload.addEventListener("progress",function(k){k=Math.round(k.loaded/k.total*100);g&&(g.value=k);h&&(h.innerHTML=`${Math.round(k)}%...`)},!1),e.addEventListener("load",function(k){k=
k.target.responseText;g&&(g.value=0);h&&(h.innerHTML="");k&&console.log(k)},!1),e.addEventListener("error",function(){h&&(h.innerHTML="Upload failed");console.log("Upload failed")},!1),e.addEventListener("abort",function(){h&&(h.innerHTML="Upload aborted");console.log("Upload aborted")},!1),e.onreadystatechange=function(){if(4===this.readyState){const k=a.ajaxCommand,l=this.status;switch(l){case 200:a.run(k.pc+1);break;case 0:break;default:try{a.runtimeError(k.lino,`Error ${l}`)}catch(p){a.reportError(p,
a)}}}},e.onerror=function(){b.onError?(a.errorMessage=this.responseText,a.run(b.onError)):a.runtimeError(b.lino,this.responseText)},a.ajaxCommand=b,d=d.startsWith("http")?d:`${window.location.origin}/${EasyCoder_Rest.restPath}/${d}`,e.open("POST",d),e.send(c);return 0}},getHandler:a=>{switch(a){case "a":return EasyCoder_Browser.A;case "alert":return EasyCoder_Browser.Alert;case "attach":return EasyCoder_Browser.Attach;case "audioclip":return EasyCoder_Browser.Audioclip;case "blockquote":return EasyCoder_Browser.BLOCKQUOTE;
case "button":return EasyCoder_Browser.BUTTON;case "canvas":return EasyCoder_Browser.CANVAS;case "clear":return EasyCoder_Browser.Clear;case "click":return EasyCoder_Browser.Click;case "convert":return EasyCoder_Browser.Convert;case "copy":return EasyCoder_Browser.Copy;case "create":return EasyCoder_Browser.Create;case "disable":return EasyCoder_Browser.Disable;case "div":return EasyCoder_Browser.DIV;case "enable":return EasyCoder_Browser.Enable;case "fieldset":return EasyCoder_Browser.FIELDSET;case "file":return EasyCoder_Browser.FILE;
case "focus":return EasyCoder_Browser.Focus;case "form":return EasyCoder_Browser.FORM;case "fullscreen":return EasyCoder_Browser.FullScreen;case "get":return EasyCoder_Browser.Get;case "h1":return EasyCoder_Browser.H1;case "h2":return EasyCoder_Browser.H2;case "h3":return EasyCoder_Browser.H3;case "h4":return EasyCoder_Browser.H4;case "h5":return EasyCoder_Browser.H5;case "h6":return EasyCoder_Browser.H6;case "highlight":return EasyCoder_Browser.Highlight;case "history":return EasyCoder_Browser.History;
case "hr":return EasyCoder_Browser.HR;case "image":return EasyCoder_Browser.IMAGE;case "img":return EasyCoder_Browser.IMG;case "input":return EasyCoder_Browser.INPUT;case "label":return EasyCoder_Browser.LABEL;case "legend":return EasyCoder_Browser.LEGEND;case "li":return EasyCoder_Browser.LI;case "location":return EasyCoder_Browser.Location;case "mail":return EasyCoder_Browser.Mail;case "on":return EasyCoder_Browser.On;case "option":return EasyCoder_Browser.OPTION;case "p":return EasyCoder_Browser.P;
case "play":return EasyCoder_Browser.Play;case "pre":return EasyCoder_Browser.PRE;case "progress":return EasyCoder_Browser.PROGRESS;case "put":return EasyCoder_Browser.Put;case "remove":return EasyCoder_Browser.Remove;case "request":return EasyCoder_Browser.Request;case "select":return EasyCoder_Browser.SELECT;case "scroll":return EasyCoder_Browser.Scroll;case "section":return EasyCoder_Browser.SECTION;case "set":return EasyCoder_Browser.Set;case "span":return EasyCoder_Browser.SPAN;case "table":return EasyCoder_Browser.TABLE;
case "tr":return EasyCoder_Browser.TR;case "td":return EasyCoder_Browser.TD;case "th":return EasyCoder_Browser.TH;case "textarea":return EasyCoder_Browser.TEXTAREA;case "trace":return EasyCoder_Browser.Trace;case "ul":return EasyCoder_Browser.UL;case "upload":return EasyCoder_Browser.Upload;default:return null}},run:a=>{const b=a[a.pc],c=EasyCoder_Browser.getHandler(b.keyword);c||a.runtimeError(b.lino,`Unknown keyword '${b.keyword}' in 'browser' package`);return c.run(a)},value:{compile:a=>{if(a.isSymbol()){var b=
a.getSymbolRecord();if(a.nextTokenIs("exists"))return"dom"===b.extra?(a.next(),{domain:"browser",type:"exists",value:b.name}):null;switch(b.keyword){case "file":case "input":case "select":case "textarea":return{domain:"browser",type:b.keyword,value:b.name}}return null}a.tokenIs("the")&&a.next();var c=!1;a.tokenIs("offset")&&(c=!0,a.next());b=a.getToken();switch(b){case "mobile":case "portrait":case "landscape":case "br":case "location":case "key":case "hostname":return a.next(),{domain:"browser",
type:b};case "browser":if(a.nextTokenIs("name"))return a.next(),{domain:"browser",type:"browserName"};break;case "content":case "text":if(a.nextTokenIs("of")){if(a.nextIsSymbol())return b=a.getSymbolRecord(),a.next(),{domain:"browser",type:"contentOf",symbol:b.name};throw Error(`'${a.getToken()}' is not a symbol`);}break;case "selected":b=a.nextToken();if(["index","item"].includes(b)&&["in","of"].includes(a.nextToken())&&a.nextIsSymbol()&&(c=a.getSymbolRecord(),["ul","ol","select"].includes(c.keyword)))return a.next(),
{domain:"browser",type:"selected",symbol:c.name,arg:b};break;case "color":return a.next(),a=a.getValue(),{domain:"browser",type:b,value:a};case "attribute":c=a.getNextValue();if(a.tokenIs("of")&&(a.next(),a.isSymbol()&&(b=a.getSymbolRecord(),"dom"===b.extra)))return a.next(),{domain:"browser",type:"attributeOf",attribute:c,symbol:b.name};break;case "style":c=a.getNextValue();if(a.tokenIs("of")&&a.nextIsSymbol()){const d=a.getSymbolRecord();if("dom"===d.extra)return a.next(),{domain:"browser",type:b,
style:c,target:d.name}}break;case "confirm":return b=a.getNextValue(),{domain:"browser",type:"confirm",text:b};case "prompt":return b=a.getNextValue(),c=null,a.tokenIs("with")&&(c=a.getNextValue()),{domain:"browser",type:"prompt",text:b,pre:c};case "screen":c=a.nextToken();if(["width","height"].includes(c))return a.next(),{domain:"browser",type:b,attribute:c};break;case "top":case "bottom":case "left":case "right":case "width":case "height":return EasyCoder_Browser.value.getCoord(a,b,c);case "scroll":if(a.nextTokenIs("position"))return a.next(),
{domain:"browser",type:"scrollPosition"};break;case "document":if(a.nextTokenIs("path"))return a.next(),{domain:"browser",type:"docPath"};break;case "storage":if(a.nextTokenIs("keys"))return a.next(),{domain:"browser",type:"storageKeys"};break;case "parent":switch(a.nextToken()){case "name":return a.next(),{domain:"browser",type:"varName"};case "index":return a.next(),{domain:"browser",type:"varIndex"}}break;case "history":if(a.nextTokenIs("state"))return a.next(),{domain:"browser",type:"historyState"};
break;case "pick":case "drag":if(a.nextTokenIs("position"))return a.next(),{domain:"browser",type:`${b}Position`};break;case "click":if(b=a.nextToken(),["left","top"].includes(b))return a.next(),{domain:"browser",type:"click",which:b}}return null},getCoord:(a,b,c)=>{if(a.nextTokenIs("of")){a.nextTokenIs("the")&&a.nextToken();var d=a.getToken();if(["window","viewport"].includes(d))return a.next(),{domain:"browser",type:b,symbol:d,offset:c};if(a.isSymbol()&&(d=a.getSymbolRecord(),"dom"===d.extra))return a.next(),
{domain:"browser",type:b,symbol:d.name,offset:c}}return null},get:(a,b)=>{let c;switch(b.type){case "file":case "input":case "select":case "textarea":c=a.getSymbolRecord(b.value);var d=c.element[c.index];return d?{type:"constant",numeric:!1,content:d.value}:(a.runtimeError(a[a.pc].lino,`Variable '${c.name}' is not attached to a DOM element.`),null);case "exists":return c=a.getSymbolRecord(b.value),{domain:"browser",type:"boolean",content:"undefined"!==typeof c.element[c.index]};case "mobile":const e=
{Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)},any:function(){return e.Android()||e.BlackBerry()||e.iOS()||e.Opera()||e.Windows()}};return{domain:"browser",type:"boolean",
content:e.any()};case "browserName":return b=navigator.userAgent,{domain:"browser",type:"constant",numeric:!1,content:b.match(/chrome|chromium|crios/i)?"Chrome":b.match(/firefox|fxios/i)?"Firefox":b.match(/safari/i)?"Safari":b.match(/opr\//i)?"Opera":b.match(/edg/i)?"Edge":b.match(/android/i)?"Android":b.match(/iphone/i)?"iPhone":"Unknown"};case "portrait":return{domain:"browser",type:"boolean",content:document.documentElement.clientWidth<document.documentElement.clientHeight};case "landscape":return{domain:"browser",
type:"boolean",content:document.documentElement.clientWidth>=document.documentElement.clientHeight};case "br":return{type:"constant",numeric:!1,content:decodeURIComponent("%3Cbr%20%2F%3E")};case "attributeOf":return c=a.getSymbolRecord(b.symbol),b=a.getValue(b.attribute),d=c.element[c.index],0===b.indexOf("data-")?a.getSimpleValue(d.dataset[b.substr(5)]):a.getSimpleValue(d[b]);case "style":return c=a.getSymbolRecord(b.target),b=a.getValue(b.style),d=c.element[c.index],a.getSimpleValue(d.style[b]);
case "confirm":return{type:"boolean",content:window.confirm(a.getValue(b.text))};case "prompt":return d=a.getValue(b.text),b=a.getValue(b.pre),{type:"constant",numeric:!1,content:b?window.prompt(d,b):window.prompt(d)};case "contentOf":c=a.getSymbolRecord(b.symbol);d=c.element[c.index];if(null===d||"undefined"===typeof d)return a.runtimeError(a[a.pc].lino,`Variable '${c.name}' is not attached to a DOM element.`),null;switch(c.keyword){case "input":case "textarea":b=d.value;break;case "pre":b=d.innerHTML;
break;default:b=d.innerHTML.split("\n").join("")}return{type:"constant",numeric:!1,content:b};case "selected":return c=a.getSymbolRecord(b.symbol),d=c.element[c.index],a=d.selectedIndex,d=0<=a?d.options[a].text:"",b="index"===b.arg?a:d,{type:"constant",numeric:!1,content:b};case "top":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.screenY};c=a.getSymbolRecord(b.symbol);a=c.element[c.index];b=Math.round(b.offset?a.offsetTop:a.getBoundingClientRect().top);return{type:"constant",
numeric:!0,content:b};case "bottom":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.screenY+window.innerHeight};c=a.getSymbolRecord(b.symbol);b=Math.round(c.element[c.index].getBoundingClientRect().bottom);return{type:"constant",numeric:!0,content:b};case "left":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.screenLeft};c=a.getSymbolRecord(b.symbol);a=c.element[c.index];b=Math.round(b.offset?a.offsetLeft:a.getBoundingClientRect().left);return{type:"constant",
numeric:!0,content:b};case "right":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.screenX+window.innerWidth};c=a.getSymbolRecord(b.symbol);b=Math.round(c.element[c.index].getBoundingClientRect().right);return{type:"constant",numeric:!0,content:b};case "width":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.innerWidth};c=a.getSymbolRecord(b.symbol);b=Math.round(c.element[c.index].getBoundingClientRect().width);return{type:"constant",numeric:!0,content:b};
case "height":if("window"==b.symbol)return{type:"constant",numeric:!0,content:window.innerHeight};c=a.getSymbolRecord(b.symbol);b=Math.round(c.element[c.index].getBoundingClientRect().height);return{type:"constant",numeric:!0,content:b};case "color":return{type:"constant",numeric:!1,content:`#${a.value.evaluate(a,b.value).content.toString(16).padStart(6,"0")}`};case "docPath":return{type:"constant",numeric:!1,content:a.docPath};case "storageKeys":return{type:"constant",numeric:!1,content:JSON.stringify(Object.keys(localStorage))};
case "location":return{type:"constant",numeric:!1,content:window.location.href};case "historyState":return{type:"constant",numeric:!1,content:window.history.state};case "scrollPosition":return{type:"constant",numeric:!0,content:scrollPosition};case "varName":return{type:"constant",numeric:!1,content:a.varName};case "varIndex":return{type:"constant",numeric:!0,content:a.varIndex};case "key":return{type:"constant",numeric:!1,content:a.key};case "hostname":return{type:"constant",numeric:!1,content:location.hostname};
case "screen":return{type:"constant",numeric:!0,content:screen[b.attribute]};case "pickPosition":return{type:"constant",numeric:!1,content:JSON.stringify({x:document.pickX,y:document.pickY})};case "dragPosition":return{type:"constant",numeric:!1,content:JSON.stringify({x:document.dragX,y:document.dragY})};case "click":a=EasyCoder_Browser.clickData;if("undefined"===typeof a)return 0;d=a.target.getBoundingClientRect();return{type:"constant",numeric:!0,content:"left"===b.which?a.clientX-Math.round(d.left):
a.clientY-Math.round(d.top)}}}},condition:{compile:a=>{if(a.tokenIs("confirm"))return{domain:"browser",type:"confirm",value:a.getNextValue()};if(a.tokenIs("element")&&a.nextIsSymbol()){const b=a.getSymbolRecord();if("dom"===b.extra){const c=a.nextToken();if("has"===c){if(a.nextTokenIs("the")&&a.next(),a.tokenIs("focus"))return a.next(),{domain:"browser",type:"focus",element:b.name}}else if("contains"===c)return a=a.getNextValue(),{domain:"browser",type:"contains",element:b.name,position:a}}}return null},
test:(a,b)=>{switch(b.type){case "confirm":return confirm(a.getValue(b.value));case "focus":var c=a.getSymbolRecord(b.element);return c.element[c.index]===document.activeElement;case "contains":c=a.getSymbolRecord(b.element);var d=c.element[c.index].getBoundingClientRect();c=Math.round(d.left);const e=Math.round(d.right),f=Math.round(d.top);d=Math.round(d.bottom);b=JSON.parse(a.getValue(b.position));a=b.x;b=b.y;return a>=c&&a<=e&&b>=f&&b<=d?!0:!1}}},setStyles:(a,b)=>{a=document.getElementById(a);
b=b.split(";");for(const c of b)b=c.split(":"),a.setAttribute(b[0],b[1])}};let scrollPosition=0;window.addEventListener("scroll",function(){scrollPosition=this.scrollY});window.onpopstate=function(a){window.EasyCoder.timestamp=Date.now();(a=JSON.parse(a.state))&&a.script&&((a=window.EasyCoder.scripts[a.script])?a.onBrowserBack&&a.run(a.onBrowserBack):console.log("No script property in window state object"))};
const EasyCoder_Json={name:"EasyCoder_Json",Json:{compile:a=>{const b=a.getLino();var c=a.nextToken();switch(c){case "set":a.next();if(a.isSymbol())if(c=a.getSymbolRecord(),"variable"===c.keyword){if(a.nextTokenIs("to")){var d=a.nextToken();if('["array","object"]'.includes(d))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:"setVariable",target:c.name,type:d}),!0}}else if("select"===c.keyword&&a.nextTokenIs("from")&&(a.next(),a.isSymbol())){var e=a.getSymbolRecord();if("variable"===
e.keyword)return d=null,a.nextTokenIs("as")&&(d=a.getNextValue()),a.addCommand({domain:"json",keyword:"json",lino:b,request:"setList",target:c.name,source:e.name,display:d}),!0}break;case "sort":case "shuffle":case "format":if(a.nextIsSymbol()&&(d=a.getSymbolRecord(),"variable"===d.keyword))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,target:d.name}),!0;break;case "parse":if(a.nextTokenIs("url")&&(d=a.getNextValue(),a.tokenIs("as")&&a.nextIsSymbol()&&(e=a.getSymbolRecord(),
"variable"===e.keyword)))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,source:d,target:e.name}),!0;break;case "delete":d=a.nextToken();if(["property","element"].includes(d)&&(e=a.getNextValue(),["from","of"].includes(a.getToken())&&a.nextIsSymbol())){var f=a.getSymbolRecord();if("variable"===f.keyword)return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,what:d,value:e,target:f.name}),!0}break;case "rename":d=a.getNextValue();if(a.tokenIs("to")&&
(e=a.getNextValue(),a.tokenIs("in")&&a.nextIsSymbol()&&(f=a.getSymbolRecord(),"variable"===f.keyword)))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,oldName:d,newName:e,target:f.name}),!0;break;case "add":d=a.getNextValue();if(a.tokenIs("to")&&a.nextIsSymbol()&&(e=a.getSymbolRecord(),"variable"===e.keyword))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,item:d,target:e.name}),!0;break;case "split":d=a.getNextValue();e="\n";a.tokenIs("on")&&
(e=a.getNextValue());if(["giving","into"].includes(a.getToken())&&a.nextIsSymbol()&&(f=a.getSymbolRecord(),"variable"===f.keyword))return a.next(),a.addCommand({domain:"json",keyword:"json",lino:b,request:c,item:d,on:e,target:f.name}),!0;break;case "replace":if(a.nextTokenIs("element")&&(d=a.getNextValue(),a.tokenIs("of")&&a.nextIsSymbol()&&(e=a.getSymbolRecord(),"variable"===e.keyword&&["by","with"].includes(a.nextToken()))))return f=a.getNextValue(),a.addCommand({domain:"json",keyword:"json",lino:b,
request:c,target:e.name,index:d,value:f}),!0}a.addWarning("Unrecognised json command syntax");return!1},run:a=>{const b=a[a.pc];switch(b.request){case "setVariable":var c=a.getSymbolRecord(b.target);var d="array"===b.type?"[]":"{}";c.value[c.index]={type:"constant",numeric:!1,content:d};break;case "setList":c=a.getSymbolRecord(b.source);c=a.getValue(c.value[c.index]);var e="";try{e=JSON.parse(c)}catch(l){return a.runtimeError(b.lino,"Can't parse JSON"),0}c=a.getSymbolRecord(b.target);const g=c.element[c.index];
g.options.length=0;const h=a.getValue(b.display);e.forEach(function(l){const p=h?a.decode(l[h]):null,q=document.createElement("option");q.innerHTML=p?p:l;l=p?JSON.stringify(l):l;q.value=l;g.appendChild(q)});g.selectedIndex=-1;break;case "sort":c=a.getSymbolRecord(b.target);d=(e=a.getValue(c.value[c.index]))?JSON.stringify(JSON.parse(e).sort()):null;c.value[c.index]={type:"constant",numeric:!1,content:d};break;case "shuffle":c=a.getSymbolRecord(b.target);e=JSON.parse(a.getValue(c.value[c.index]));
for(d=e.length-1;0<d;d--){var f=Math.floor(Math.random()*(d+1));[e[d],e[f]]=[e[f],e[d]]}c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(e)};break;case "format":c=a.getSymbolRecord(b.target);e=JSON.parse(a.getValue(c.value[c.index]));c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(e,null,2)};break;case "parse":e=a.getValue(b.source);c=a.getSymbolRecord(b.target);d={url:e};f=e.indexOf("://");0<=f&&(f+=3,d.protocol=e.substr(0,f),e=e.substr(f));f=e.indexOf("?");
0<f?(d.domain=e.substr(0,f),d.arg=e.substr(f+1)):d.domain=e;d.domain.endsWith("/")&&(d.domain=d.domain.slice(0,-1));f=d.domain.indexOf("/");0<f?(d.path=d.domain.substr(f+1),d.domain=d.domain.substr(0,f)):d.path="";c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(d,null,2)};break;case "delete":switch(b.what){case "property":d=a.getValue(b.value);c=a.getSymbolRecord(b.target);e=JSON.parse(c.value[c.index].content);delete e[d];c.value[c.index].content=JSON.stringify(e);break;case "element":d=
a.getValue(b.value),c=a.getSymbolRecord(b.target),e=JSON.parse(c.value[c.index].content),e.splice(d,1),c.value[c.index].content=JSON.stringify(e)}break;case "rename":f=a.getValue(b.oldName);const k=a.getValue(b.newName);c=a.getSymbolRecord(b.target);e=JSON.parse(c.value[c.index].content);d=e[f];delete e[f];e[k]=d;c.value[c.index].content=JSON.stringify(e);break;case "add":d=a.getValue(b.item);c=a.getSymbolRecord(b.target);e=(e=c.value[c.index].content)?JSON.parse(e):[];e.push(a.isJsonString(d)?JSON.parse(d):
d);c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(e)};break;case "split":d=a.getValue(b.item);e=a.getValue(b.on);c=a.getSymbolRecord(b.target);c.value[c.index]={type:"constant",numeric:!1,content:JSON.stringify(d.split(e))};break;case "replace":c=a.getSymbolRecord(b.target),d=a.getValue(b.index),f=a.getValue(b.value),e=(e=c.value[c.index].content)?JSON.parse(e):[],d>e.length-1&&a.runtimeError(b.lino,"Index out of range"),e[d]=f,c.value[c.index].content=JSON.stringify(e)}return b.pc+
1}},getHandler:a=>{switch(a){case "json":return EasyCoder_Json.Json;default:return null}},run:a=>{const b=a[a.pc],c=EasyCoder_Json.getHandler(b.keyword);c||a.runtimeError(b.lino,`Unknown keyword '${b.keyword}' in 'json' package`);return c.run(a)},value:{compile:a=>{a.tokenIs("the")&&a.next();if(a.tokenIs("json")){const c=a.nextToken();if(["size","count"].includes(c)){if(a.skip("of"),a.isSymbol()){var b=a.getSymbolRecord();a.next();if(b.isVHolder)return{domain:"json",type:c,name:b.name}}}else if("keys"===
c){if(b=!0,a.nextTokenIs("unsorted")&&(b=!1,a.next()),a.tokenIs("of")&&a.nextIsSymbol()){const d=a.getSymbolRecord();a.next();if(d.isVHolder)return{domain:"json",type:c,name:d.name,sorted:b}}}else if("index"===c&&a.nextTokenIs("of")&&(b=a.getNextValue(),a.tokenIs("in")))return a=a.getNextValue(),{domain:"json",type:c,item:b,list:a}}return null},get:(a,b)=>{let c;switch(b.type){case "size":case "count":c=a.getSymbolRecord(b.name);a=a.getValue(c.value[c.index]);try{var d=JSON.parse(a)}catch(f){d=[]}return{type:"constant",
numeric:!0,content:d?d.length:0};case "keys":return c=a.getSymbolRecord(b.name),d=(a=a.getValue(c.value[c.index]))?JSON.stringify(Object.keys(JSON.parse(a)).sort()):"[]",a?(d=Object.keys(JSON.parse(a)),b.sorted&&(d=d.sort()),d=JSON.stringify(d)):d="[]",{type:"constant",numeric:!1,content:d};case "index":const e=a.getValue(b.item);d=JSON.parse(a.getValue(b.list)).findIndex(function(f){return f===e});return{type:"constant",numeric:!0,content:d}}}},condition:{compile:()=>{},test:()=>{}}},EasyCoder_Rest=
{name:"EasyCoder_Rest",Rest:{compile:a=>{const b=a.getLino();switch(a.nextToken()){case "path":var c=a.getNextValue();a.addCommand({domain:"rest",keyword:"rest",lino:b,request:"path",path:c});return!0;case "get":if(a.nextIsSymbol(!0)&&(c=a.getSymbolRecord(),"variable"===c.keyword&&a.nextTokenIs("from"))){var d=a.getNextValue(),e=a.getPc();a.addCommand({domain:"rest",keyword:"rest",lino:b,request:"get",target:c.name,url:d,onError:null});a.tokenIs("or")&&(a.next(),a.getCommandAt(e).onError=a.getPc()+
1,a.completeHandler());return!0}break;case "post":c=null;if(a.nextTokenIs("to"))a.next();else if(c=a.getValue(),a.tokenIs("to"))a.next();else break;d=a.getValue();if(!d)throw Error(command.lino,"No URL present");var f=null;for(e={};a.tokenIs("with");){const g=a.nextToken();if(a.nextTokenIs("as")){const h=a.getNextValue();e[g]=h}else break}if(a.tokenIs("giving")&&a.nextIsSymbol())if(f=a.getSymbolRecord(),f.isVHolder)f=f.name,a.next();else throw Error(`'${f.name}' cannot hold a value`);a.addCommand({domain:"rest",
keyword:"rest",lino:b,request:"post",value:c,url:d,target:f,args:e,onError:a.getPc()+2});onError=null;a.tokenIs("or")&&(a.next(),a.completeHandler());return!0}return!1},createCORSRequest:(a,b)=>{var c=new XMLHttpRequest;"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null;return c},run:a=>{const b=a[a.pc];if("path"==b.request)return EasyCoder_Rest.restPath=a.getValue(b.path),b.pc+1;var c=a.getValue(b.url);EasyCoder_Rest.restPath||(EasyCoder_Rest.restPath=
".");var d=c;c.startsWith("http")||(d="/"==c[0]?c.substr(1):`${EasyCoder_Rest.restPath}/${c}`);const e=EasyCoder_Rest.Rest.createCORSRequest(b.request,d);if(e){e.script=a.script;e.program=a;e.pc=a.pc;e.onload=function(){let f=EasyCoder.scripts[e.script],g=f[e.pc];if(200<=e.status&&400>e.status){var h=e.responseText.trim();if(g.target){const k=a.getSymbolRecord(b.target);k.value[k.index]={type:"constant",numeric:!1,content:h};k.used=!0}f.run(g.pc+1)}else h=`${e.status} ${e.statusText}`,g.onError?(f.errorMessage=
`Exception trapped: ${h}`,f.run(g.onError)):f.runtimeError(g.lino,`Error: ${h}`)};e.onerror=function(){b.onError?(a.errorMessage=this.responseText,e.program.run(b.onError)):e.program.runtimeError(b.lino,this.responseText)};switch(b.request){case "get":e.send();break;case "post":c=a.getValue(b.value);console.log(`POST to ${d}`);e.setRequestHeader("Content-type","application/json; charset=UTF-8");for(key of Object.keys(b.args))d=e.program.getValue(b.args[key]),e.setRequestHeader(key,d);e.send(c)}return 0}a.runtimeError(b.lino,
"CORS not supported")}},getHandler:a=>{switch(a){case "rest":return EasyCoder_Rest.Rest;default:return null}},run:a=>{const b=a[a.pc],c=EasyCoder_Rest.getHandler(b.keyword);c||a.runtimeError(b.lino,`Unknown keyword '${b.keyword}' in 'rest' package`);return c.run(a)},value:{compile:()=>null,get:()=>null},condition:{compile:()=>{},test:()=>{}}},EasyCoder_Compare=(a,b,c)=>{b=a.value.evaluate(a,b);a=a.value.evaluate(a,c);c=b.content;var d=a.content;c&&b.numeric?a.numeric||(d=""===d||"-"===d||"undefined"===
typeof d?0:parseInt(d)):(d&&a.numeric&&(d=d.toString()),"undefined"===typeof c&&(c=""),"undefined"===typeof d&&(d=""));return c>d?1:c<d?-1:0},EasyCoder_Condition={name:"EasyCoder_Condition",compile:a=>{const b=a.getIndex();for(const c of Object.keys(a.domain)){const d=a.domain[c].condition.compile(a);if(d)return d;a.rewindto(b)}},test:(a,b)=>a.domain[b.domain].condition.test(a,b)},EasyCoder_Value={name:"EasyCoder_Value",getItem:a=>{var b=a.getToken();if(!b)return null;if("true"===b)return a.next(),
{type:"boolean",content:!0};if("false"===b)return a.next(),{type:"boolean",content:!1};if("`"===b.charAt(0))return a.next(),{type:"constant",numeric:!1,content:b.substring(1,b.length-1)};if(b.charAt(0).match(/[0-9-]/)){var c=eval(b);if(Number.isInteger(c))return a.next(),{type:"constant",numeric:!0,content:c};throw Error(`'${b}' is not an integer`);}b=a.getIndex();for(c of Object.keys(a.domain)){const d=a.domain[c].value.compile(a);if(d)return d;a.rewindTo(b)}return null},compile:a=>{const b=a.getToken();
let c=EasyCoder_Value.getItem(a);if(!c)throw Error(`Undefined value: '${b}'`);if("cat"===a.getToken()){const d={type:"cat",numeric:!1,parts:[c]};for(;a.tokenIs("cat");){a.next();c=EasyCoder_Value.getItem(a);if(!c)throw Error(`Undefined value: '${b}'`);d.parts.push(c)}return d}return c},doValue:(a,b)=>{if("undefined"===typeof b.type)return a.runtimeError(a[a.pc].lino,"Undefined value (variable not initialized?)"),null;switch(b.type){case "cat":return{type:"constant",numeric:!1,content:b.parts.reduce(function(d,
e){e=EasyCoder_Value.doValue(a,e);return d+(e?e.content:"")},"")};case "boolean":case "constant":return b;case "symbol":var c=a.getSymbolRecord(b.name);if(c.isVHolder){if(b=c.value[c.index]){c=b.content;if(null===c||"undefined"===typeof c)b.content=b.numeric?0:"";return b}return null}return a.domain[c.domain].value.get(a,b)}return a.domain[b.domain].value.get(a,b)},constant:(a,b)=>({type:"constant",numeric:b,content:a}),evaluate:(a,b)=>{if(!b)return{type:"constant",numeric:!1,content:""};const c=
EasyCoder_Value.doValue(a,b);if(c)return c;a.runtimeError(a[a.pc].lino,"Can't decode value: "+b)},getValue:(a,b)=>(a=EasyCoder_Value.evaluate(a,b))?a.content:null,encode:(a,b)=>{if(a)switch(b){default:case "ec":return a.replace(/\n/g,"~lf~").replace(/%0a/g,"~lf~").replace(/\n/g,"~cr~").replace(/%0d/g,"~cr~").replace(/"/g,"~dq~").replace(/'/g,"~sq~").replace(/\\/g,"~bs~");case "url":return encodeURIComponent(a.replace(/\s/g,"+"));case "base64":return btoa(a);case "sanitize":return a.normalize("NFD").replace(/[\u0300-\u036f]/g,
"")}return a},decode:(a,b)=>{if(a)switch(b){default:case "ec":return a.replace(/%0a/g,"\n").replace(/~lf~/g,"\n").replace(/%0d/g,"\r").replace(/~cr~/g,"\n").replace(/~dq~/g,'"').replace(/~sq~/g,"'").replace(/~bs~/g,"\\");case "url":return decodeURIComponent(a).replace(/\+/g," ");case "base64":return atob(a)}return a}},EasyCoder_Run={name:"EasyCoder_Run",run:(a,b)=>{const c=[],d=l=>{let p=9999;l.forEach(function(q){q=q.line;let n=0;for(;n<q.length&&" "===q[n];)n++;0<n&&n<p&&(p=n)});return 0};if(c.length)c.push(b);
else for(a.register(a),c.push(b);0<c.length;)for(a.pc=c.shift(),a.watchdog=0;a.running;){if(1E6<a.watchdog){a.lino=a[a.pc].lino;a.reportError(Error("Program runaway intercepted.\nHave you forgotten to increment a loop counter?",a),a);break}a.watchdog++;b=a[a.pc].domain;if(a.debugStep){var e=a[a.pc].lino,f="";try{f=a.source.scriptLines[e-1].line}catch(l){}console.log(`${a.script}: Line ${e}: `+`${b}:${a[a.pc].keyword} - ${f}`)}e=a.domain[b];if(!e){a.runtimeError(a[a.pc].lino,`Unknown domain '${b}'`);
break}a.pc=e.run(a);if(!a.pc)break;if(a.stop){a.tracing=!1;break}if(a.tracing){b=a[a.pc];e=a.source.scriptLines;f=d(e);var g=document.getElementById("easycoder-tracer");if(!g){a.runtimeError(b.lino,"Element 'easycoder-tracer' was not found");return}g.style.display="block";g.style.visibility="visible";var h="";if(a.tracer){const l=document.getElementById("easycoder-tracer-content");if(l){a.tracer.variables.forEach(function(n,t,v){var r=a.getSymbolRecord(n);if(1<r.elements)for(h+=`${n}: ${r.index}/${r.elements}: `,
n=0;n<r.elements;n++){const u=r.value[n];h=u?h+`${u.content} `:h+"undefined "}else h=(r=r.value[r.index])?h+`${n}: ${r.content}`:h+`${n}: undefined`;switch(a.tracer.alignment){case "horizontal":t<v.length-1&&(h+=", ");break;case "vertical":h+="<br>"}});h+="<hr>";g="";for(var k=5;0<k;k--){if(b.lino){const n=e[b.lino-k].line.substr(f);g+=`<input type="text" name="${k}"`+`value="${b.lino-k+1}: ${n.split("\\s").join(" ")}"`+'style="width:100%;border:none;enabled:false">'}g+="<br>"}l.innerHTML=`${h} ${g}`;
l.style.display="block";const p=document.getElementById("easycoder-run-button"),q=document.getElementById("easycoder-step-button");p.onclick=function(){p.blur();a.tracing=!1;document.getElementById("easycoder-tracer-content").style.display="none";try{EasyCoder_Run.run(a,a.resume)}catch(n){const t="Error in run handler: "+n.message;console.log(t);alert(t)}};q.onclick=function(){console.log("step");q.blur();a.tracing=!0;document.getElementById("easycoder-tracer-content").style.display="block";try{a.run(a.resume)}catch(n){const t=
"Error in step handler: "+n.message;console.log(t);alert(t)}}}a.resume=a.pc;a.pc=0}break}}},exit:a=>{a.onExit&&a.run(a.onExit);let b=a.parent,c=a.afterExit;delete EasyCoder.scripts[a.script];a.module&&delete a.module.program;Object.keys(a).forEach(function(d){delete a[d]});b&&c&&EasyCoder.scripts[b].run(c)}},EasyCoder_Compiler={name:"EasyCoder_Compiler",getTokens:function(){return this.tokens},addWarning:function(a){this.warnings.push(a)},warning:function(a){this.addWarning(a)},unrecognisedSymbol:function(a){this.addWarning(`Unrecognised symbol '${a}'`)},
getWarnings:function(){return this.warnings},getIndex:function(){return this.index},next:function(a=1){this.index+=a},peek:function(){return this.tokens[this.index+1].token},more:function(){return this.index<this.tokens.length},getToken:function(){return this.index>=this.tokens.length?null:this.tokens[this.index]?this.tokens[this.index].token:null},nextToken:function(){this.next();return this.getToken()},tokenIs:function(a){return this.index>=this.tokens.length?!1:a===this.tokens[this.index].token},
nextTokenIs:function(a){this.next();return this.tokenIs(a)},skip:function(a){if(this.index>=this.tokens.length)return null;this.next();this.tokenIs(a)&&this.next()},prev:function(){this.index--},getLino:function(){return this.index>=this.tokens.length?0:this.tokens[this.index].lino},getTarget:function(a=this.index){return this.tokens[a].token},getTargetPc:function(a=this.index){return this.symbols[this.getTarget(a)].pc},getCommandAt:function(a){return this.program[a]},isSymbol:function(a=!1){if(this.getTarget()in
this.symbols)return!0;if(a)throw Error(`Unknown symbol: '${this.getTarget()}'`);return!1},nextIsSymbol:function(a=!1){this.next();return this.isSymbol(a)},getSymbol:function(a=!1){if(this.isSymbol(a))return this.symbols[this.getToken()]},getSymbolPc:function(a=!1){return this.getSymbol(a).pc},getSymbolRecord:function(){const a=this.program[this.getSymbolPc(!0)];a.used=!0;return a},getSymbols:function(){return this.symbols},getProgram:function(){return this.program},getPc:function(){return this.program.length},
getValue:function(){return this.value.compile(this)},getNextValue:function(){this.next();return this.getValue()},getCondition:function(){return this.condition.compile(this)},constant:function(a,b=!1){return this.value.constant(a,b)},addCommand:function(a){a.pc=this.program.length;this.program.push(a)},addSymbol:function(a,b){this.symbols[a]={pc:b}},rewindTo:function(a){this.index=a},completeHandler:function(){const a=this.getLino(),b=this.getPc();this.addCommand({domain:"core",keyword:"goto",lino:a,
goto:0});this.compileOne();this.continue?(this.addCommand({domain:"core",keyword:"goto",lino:a,goto:this.getPc()+1}),this.continue=!1):this.addCommand({domain:"core",keyword:"stop",lino:a,next:0});this.getCommandAt(b).goto=this.getPc();return!0},compileVariable:function(a,b,c=!1,d=null){this.next();const e=this.getLino(),f=this.getTokens()[this.getIndex()];if(this.symbols[f.token])throw Error(`Duplicate variable name '${f.token}'`);const g=this.getPc();this.next();this.addSymbol(f.token,g);a={domain:a,
keyword:b,lino:e,isSymbol:!0,used:!1,isVHolder:c,name:f.token,elements:1,index:0,value:[{}],element:[],extra:d};"dom"===d&&(a.element=[]);this.addCommand(a);return a},compileToken:function(){const a=this.getToken();if(a){var b=this.getIndex();for(const d of Object.keys(this.domain)){var c=this.domain[d];if(c&&(c=c.getHandler(a))&&c.compile(this))return;this.rewindTo(b)}console.log("No handler found");throw Error(`I don't understand '${a}...'`);}},compileOne:function(){var a=this.getToken();if(a){this.warnings=
[];var b=this.program.length;if(a.endsWith(":")){a=a.substring(0,a.length-1);if(this.symbols[a])throw Error(`Duplicate symbol: '${a}'`);this.symbols[a]={pc:b};this.index++}else this.compileToken()}},compileFromHere:function(a){for(;this.index<this.tokens.length;){const b=this.tokens[this.index].token;if("else"===b)return this.program;this.compileOne();if(-1<a.indexOf(b))break}},compile:function(a){this.tokens=a;this.index=0;this.program=[];this.program.script=0;this.program.symbols={};this.symbols=
this.program.symbols;this.warnings=[];this.compileFromHere([]);this.addCommand({domain:"core",keyword:"exit",lino:this.getLino(),next:0});for(const b in this.symbols)a=this.program[this.symbols[b].pc],!a.isSymbol||a.used||a.exporter||console.log(`Symbol '${a.name}' has not been used.`);return this.program}},EasyCoder={name:"EasyCoder_Main",domain:{core:EasyCoder_Core,browser:EasyCoder_Browser,json:EasyCoder_Json,rest:EasyCoder_Rest},elementId:0,runtimeError:function(a,b){this.lino=a;this.reportError({message:`Line ${0<=
a?a:""}: ${b}`},this.program);this.program&&(this.program.aborted=!0)},nonNumericValueError:function(a){this.runtimeError(a,"Non-numeric value")},variableDoesNotHoldAValueError:function(a,b){this.runtimeError(a,`Variable '${b}' does not hold a value`)},reportError:function(a,b,c){if(a.message)if(this.compiling||b){var {tokens:d,scriptLines:e}=c?c:b.source;c=EasyCoder_Compiler;var f=this.compiling?d[c.getIndex()].lino:b[b.pc].lino;b=this.compiling?`Compile error in '${c.script}'`:`Runtime error in '${b.script}'`;
b+=":\n";var g=f-5;for(g=0>g?0:g;g<f;g++){const k=(""+(g+1)).padStart(4," ");b+=k+" "+e[g].line.split("\\s").join(" ")+"\n"}b+=`${a.message}\n`;a=c.getWarnings();if(a.length){b+="Warnings:\n";for(var h of a)b+=`${h}\n`}console.log(b);alert(b)}else h=`Error: ${a.message}`,alert(h),console.log(h);else console.log(`An error occurred - origin was ${a.path[0]}`)},getSymbolRecord:function(a){a=this[this.symbols[a].pc];return a.alias?this.getSymbolRecord(a.alias):a.exporter?EasyCoder.scripts[a.exporter].getSymbolRecord(a.exportedName):
a},verifySymbol:function(a){return"undefined"!==typeof this.symbols[a]},encode:function(a){return EasyCoder_Value.encode(a,this.encoding)},decode:function(a){return EasyCoder_Value.decode(a,this.encoding)},evaluate:function(a){return EasyCoder_Value.evaluate(this,a)},getValue:function(a){return EasyCoder_Value.getValue(this,a)},getFormattedValue:function(a){a=EasyCoder_Value.evaluate(this,a);if(a.numeric)return a.content;if("boolean"===a.type)return a.content?"true":"false";if(this.isJsonString(a.content))try{const b=
JSON.parse(a.content);return JSON.stringify(b,null,2)}catch(b){return this.reportError(b),"{}"}return a.content},getSimpleValue:function(a){return!0===a||!1===a?{type:"boolean",content:a}:{type:"constant",numeric:Number.isInteger(a),content:a}},run:function(a){a&&(this.program=this,EasyCoder_Run.run(this,a))},exit:function(){EasyCoder_Run.exit(this)},register:a=>{this.program=a},require:function(a,b,c){let d="";"/"==b[0]&&(d=window.location.origin+"/");const e=document.createElement("css"===a?"link":
"script");switch(a){case "css":e.type="text/css";e.href=`${d}${b}`;e.rel="stylesheet";break;case "js":e.type="text/javascript";e.src=`${d}${b}`;break;default:return}e.onload=function(){console.log(`${Date.now()-EasyCoder.timestamp} ms: Library ${d}${b} loaded`);c()};document.head.appendChild(e)},isUndefined:a=>"undefined"===typeof a,isJsonString:function(a){if(["{","["].includes(a[0])){try{JSON.parse(a)}catch(b){return!1}return!0}return!1},runScript:function(a){const b=a[a.pc],c=a.getValue(b.script),
d=b.imports;d.caller=a.script;const e=b.module?a.getSymbolRecord(b.module):null;try{EasyCoder.tokeniseAndCompile(c.split("\n"),d,e,this.script,b.then)}catch(f){EasyCoder.reportError(f,a,a.source);a.onError?a.run(a.onError):(a=EasyCoder.scripts[a.parent])&&a.onError&&a.run(a.onError);return}b.nowait&&EasyCoder.run(a.nextPc)},close:function(){},compileScript:function(a,b,c,d){const {tokens:e}=a;this.compiling=!0;const f=EasyCoder_Compiler;this.compiler=f;f.value=EasyCoder_Value;f.condition=EasyCoder_Condition;
f.parent=d;f.domain=this.domain;f.imports=b;f.continue=!1;b=f.compile(e);this.compiling=!1;b.EasyCoder=this;b.value=EasyCoder_Value;b.condition=EasyCoder_Condition;b.compare=EasyCoder_Compare;b.source=a;b.run=this.run;b.exit=this.exit;b.runScript=this.runScript;b.evaluate=this.evaluate;b.getValue=this.getValue;b.getFormattedValue=this.getFormattedValue;b.getSimpleValue=this.getSimpleValue;b.encode=this.encode;b.decode=this.decode;b.domain=this.domain;b.require=this.require;b.isUndefined=this.isUndefined;
b.isJsonString=this.isJsonString;b.getSymbolRecord=this.getSymbolRecord;b.verifySymbol=this.verifySymbol;b.runtimeError=this.runtimeError;b.nonNumericValueError=this.nonNumericValueError;b.variableDoesNotHoldAValueError=this.variableDoesNotHoldAValueError;b.reportError=this.reportError;b.register=this.register;b.symbols=f.getSymbols();b.unblocked=!1;b.encoding="ec";b.popups=[];b.programStack=[];b.dataStack=[];b.queue=[0];b.module=c;b.parent=d;c&&(c.program=b.script);return b},tokeniseFile:function(a){const b=
[],c=[];let d=0;a.forEach(function(e,f){b.push({lino:f+1,line:e});const g=e.length;let h="",k=!0;for(let l=0;l<g;l++){const p=e[l];if(0==p.trim().length)k||(c.push({index:d,lino:f+1,token:h}),d++,h="",k=!0);else if(k=!1,"`"===p){for(m=l;++l<e.length&&"`"!==e[l];);h=e.substr(m,l-m+1)}else if("!"==p)break;else h+=p}0<h.length&&c.push({index:d,lino:f+1,token:h})});return{scriptLines:b,tokens:c}},tokeniseAndCompile:function(a,b,c,d,e){let f=null;const g=Date.now();a=this.tokeniseFile(a);try{f=this.compileScript(a,
b,c,d);f.script||(f.script=EasyCoder.scriptIndex,EasyCoder.scriptIndex++);const h=Date.now();console.log(`${h-this.timestamp} ms: `+`Compiled ${f.script}: ${a.scriptLines.length} lines (${a.tokens.length} tokens) in `+`${h-g} ms`)}catch(h){"stop"!==h.message&&(b=EasyCoder.scripts[d],this.reportError(h,b,a),b&&b.onError&&b.run(b.onError),EasyCoder_Compiler.script&&(delete EasyCoder.scripts[EasyCoder_Compiler.script],delete EasyCoder_Compiler.script));return}f&&(EasyCoder.scripts[f.script]=f,c&&(c.program=
f.script),f.afterExit=e,f.running=!0,EasyCoder_Run.run(f,0))},start:function(a){EasyCoder.restPath="rest.php";EasyCoder.scriptIndex=0;const b=a.split("\n");if(!this.tokenising){try{this.tokeniseAndCompile(b)}catch(c){this.reportError(c,null,a)}this.tokenising=!0}},version:"240914"};EasyCoder.timestamp=Date.now();console.log("EasyCoder loaded; waiting for page");
function EasyCoder_Startup(){console.log(`${Date.now()-EasyCoder.timestamp} ms: Start EasyCoder`);EasyCoder.timestamp=Date.now();EasyCoder.scripts={};window.EasyCoder=EasyCoder;const a=document.getElementById("easycoder-script");if(a){a.style.display="none";try{EasyCoder.start(a.innerText)}catch(b){EasyCoder.reportError(b)}}}window.onload=EasyCoder_Startup;
